/* ----------------------------------------
Código exportado desde SAS Enterprise Guide
FECHA: viernes, 13 de diciembre de 2024     HORA: 10:28:11
PROYECTO: ProyectoESG_20241213
RUTA DEL PROYECTO: C:\Users\x100340\OneDrive - Santander Office 365\General - MS Loan Tapes Interno\Pillar III\02. CÓDIGO\01. SAS Piloto Nov24\ProyectoESG_20241213.egp
---------------------------------------- */

/* ---------------------------------- */
/* MACRO: enterpriseguide             */
/* PURPOSE: define a macro variable   */
/*   that contains the file system    */
/*   path of the WORK library on the  */
/*   server.  Note that different     */
/*   logic is needed depending on the */
/*   server type.                     */
/* ---------------------------------- */
%macro enterpriseguide;
%global sasworklocation;
%local tempdsn unique_dsn path;

%if &sysscp=OS %then %do; /* MVS Server */
	%if %sysfunc(getoption(filesystem))=MVS %then %do;
        /* By default, physical file name will be considered a classic MVS data set. */
	    /* Construct dsn that will be unique for each concurrent session under a particular account: */
		filename egtemp '&egtemp' disp=(new,delete); /* create a temporary data set */
 		%let tempdsn=%sysfunc(pathname(egtemp)); /* get dsn */
		filename egtemp clear; /* get rid of data set - we only wanted its name */
		%let unique_dsn=".EGTEMP.%substr(&tempdsn, 1, 16).PDSE"; 
		filename egtmpdir &unique_dsn
			disp=(new,delete,delete) space=(cyl,(5,5,50))
			dsorg=po dsntype=library recfm=vb
			lrecl=8000 blksize=8004 ;
		options fileext=ignore ;
	%end; 
 	%else %do; 
        /* 
		By default, physical file name will be considered an HFS 
		(hierarchical file system) file. 
		*/
		%if "%sysfunc(getoption(filetempdir))"="" %then %do;
			filename egtmpdir '/tmp';
		%end;
		%else %do;
			filename egtmpdir "%sysfunc(getoption(filetempdir))";
		%end;
	%end; 
	%let path=%sysfunc(pathname(egtmpdir));
    %let sasworklocation=%sysfunc(quote(&path));  
%end; /* MVS Server */
%else %do;
	%let sasworklocation = "%sysfunc(getoption(work))/";
%end;
%if &sysscp=VMS_AXP %then %do; /* Alpha VMS server */
	%let sasworklocation = "%sysfunc(getoption(work))";                         
%end;
%if &sysscp=CMS %then %do; 
	%let path = %sysfunc(getoption(work));                         
	%let sasworklocation = "%substr(&path, %index(&path,%str( )))";
%end;
%mend enterpriseguide;

%enterpriseguide


/* Conditionally delete set of tables or views, if they exists          */
/* If the member does not exist, then no action is performed   */
%macro _eg_conditional_dropds /parmbuff;
	
   	%local num;
   	%local stepneeded;
   	%local stepstarted;
   	%local dsname;
	%local name;

   	%let num=1;
	/* flags to determine whether a PROC SQL step is needed */
	/* or even started yet                                  */
	%let stepneeded=0;
	%let stepstarted=0;
   	%let dsname= %qscan(&syspbuff,&num,',()');
	%do %while(&dsname ne);	
		%let name = %sysfunc(left(&dsname));
		%if %qsysfunc(exist(&name)) %then %do;
			%let stepneeded=1;
			%if (&stepstarted eq 0) %then %do;
				proc sql;
				%let stepstarted=1;

			%end;
				drop table &name;
		%end;

		%if %sysfunc(exist(&name,view)) %then %do;
			%let stepneeded=1;
			%if (&stepstarted eq 0) %then %do;
				proc sql;
				%let stepstarted=1;
			%end;
				drop view &name;
		%end;
		%let num=%eval(&num+1);
      	%let dsname=%qscan(&syspbuff,&num,',()');
	%end;
	%if &stepstarted %then %do;
		quit;
	%end;
%mend _eg_conditional_dropds;


/* save the current settings of XPIXELS and YPIXELS */
/* so that they can be restored later               */
%macro _sas_pushchartsize(new_xsize, new_ysize);
	%global _savedxpixels _savedypixels;
	options nonotes;
	proc sql noprint;
	select setting into :_savedxpixels
	from sashelp.vgopt
	where optname eq "XPIXELS";
	select setting into :_savedypixels
	from sashelp.vgopt
	where optname eq "YPIXELS";
	quit;
	options notes;
	GOPTIONS XPIXELS=&new_xsize YPIXELS=&new_ysize;
%mend _sas_pushchartsize;

/* restore the previous values for XPIXELS and YPIXELS */
%macro _sas_popchartsize;
	%if %symexist(_savedxpixels) %then %do;
		GOPTIONS XPIXELS=&_savedxpixels YPIXELS=&_savedypixels;
		%symdel _savedxpixels / nowarn;
		%symdel _savedypixels / nowarn;
	%end;
%mend _sas_popchartsize;


ODS PROCTITLE;
OPTIONS DEV=SVG;
GOPTIONS XPIXELS=0 YPIXELS=0;
%macro HTML5AccessibleGraphSupported;
    %if %_SAS_VERCOMP(9, 4, 4) >= 0 %then ACCESSIBLE_GRAPH;
%mend;
FILENAME EGHTMLX TEMP;
ODS HTML5(ID=EGHTMLX) FILE=EGHTMLX
    OPTIONS(BITMAP_MODE='INLINE')
    %HTML5AccessibleGraphSupported
    ENCODING='utf-8'
    STYLE=HTMLBlue
    NOGTITLE
    NOGFOOTNOTE
    GPATH=&sasworklocation
;

/*   INICIO DEL NODO: S84   */
%LET _CLIENTTASKLABEL='S84';
%LET _CLIENTPROCESSFLOWNAME='Flujo del proceso';
%LET _CLIENTPROJECTPATH='C:\Users\x100340\OneDrive - Santander Office 365\General - MS Loan Tapes Interno\Pillar III\02. CÓDIGO\01. SAS Piloto Nov24\ProyectoESG_20241213.egp';
%LET _CLIENTPROJECTPATHHOST='SA09649X100340P';
%LET _CLIENTPROJECTNAME='ProyectoESG_20241213.egp';
%LET _SASPROGRAMFILE='';
%LET _SASPROGRAMFILEHOST='';


/*%MACRO S84(IN_PERIMETRO_84,IN_CC, TABLA_OUT);*/
/*SATELITE 84*/
*COMB_ID**************************************************************************************;
DATA sat84;
SET SAVE.DMAAS_ESG_84_202406_F;
FORMAT MAIN_CATEGORY_C $6.;
IF CLASSIFIED_AS_HELD_FOR_SALE = 'CLASSIFIED AS HELD FOR SALE' THEN CLASSIFIED_AS_HELD_FOR_SALE_C = 'HFS1';
IF CLASSIFIED_AS_HELD_FOR_SALE = 'OTHER THAN CLASSIFIED AS HELD FOR SALE' THEN CLASSIFIED_AS_HELD_FOR_SALE_C = 'HFS2';

IF BASE = 'ASSETS' THEN BASE_C = 'B01';
IF BASE = 'OFF BALANCE' THEN BASE_C = 'M01';

IF MAIN_CATEGORY in ('SUBSIDIARIES','ASSOCIATES', 'JOINT VENTURES') THEN DO; MAIN_CATEGORY= 'INVESTMENTS IN SUBSIDIARIES, JOINT VENTURES AND ASSOCIATES'; MAIN_CATEGORY_C = 'MC08';END;
IF MAIN_CATEGORY in ('BUILDINGS', 'LAND','REAL ESTATE')THEN DO; MAIN_CATEGORY = 'REAL ESTATE';MAIN_CATEGORY_C = 'MC1005'; END;
IF MAIN_CATEGORY = 'LOANS AND ADVANCES' THEN MAIN_CATEGORY_C = 'MC02';
IF MAIN_CATEGORY = 'DEBT SECURITIES ACQUIRED' THEN MAIN_CATEGORY_C = 'MC04';
IF MAIN_CATEGORY = 'EQUITY INSTRUMENTS' THEN MAIN_CATEGORY_C = 'MC06';
IF MAIN_CATEGORY = 'INVESTMENTS IN SUBSIDIARIES, JOINT VENTURES AND ASSOCIATES' THEN MAIN_CATEGORY_C = 'MC08';
IF MAIN_CATEGORY = 'FINANCIAL GUARANTEES GIVEN' THEN MAIN_CATEGORY_C = 'MC41';
 
/*INCORPORADOS JUN24*/
IF MAIN_CATEGORY IN ('OTHER INTANGIBLE ASSETS', 'INTANGIBLE ASSETS') THEN MAIN_CATEGORY_C = "MC11";
IF MAIN_CATEGORY = 'CASH ON HAND' THEN MAIN_CATEGORY_C = "MC01"; 
IF MAIN_CATEGORY = 'CREDIT INVESTMENT IN SECURITIZATION VEHICLES' THEN MAIN_CATEGORY_C = "MC03";
IF MAIN_CATEGORY = 'DERIVATIVES' THEN MAIN_CATEGORY_C = "MC05";
IF MAIN_CATEGORY = 'FAIR VALUE CHANGES OF THE HEDGED ITEMS IN PORTFOLIO HEDGE OF INTEREST RATE RISK - ASSET' THEN MAIN_CATEGORY_C = "MC07";
IF MAIN_CATEGORY = 'INSURANCE AND REINSURANCE CONTRACTS - ASSETS' THEN MAIN_CATEGORY_C = "MC09";
IF MAIN_CATEGORY = 'LOAN COMMITMENTS GIVEN' THEN MAIN_CATEGORY_C = "MC42";
IF MAIN_CATEGORY = 'OTHER COMMITMENTS GIVEN' THEN MAIN_CATEGORY_C = "MC43";
IF MAIN_CATEGORY = 'TAX ASSETS' THEN MAIN_CATEGORY_C = "MC12";
IF MAIN_CATEGORY IN ('INSURANCE CONTRACTS LINKED TO PENSIONS','OTHER ASSETS') THEN MAIN_CATEGORY_C = "MC13";
IF MAIN_CATEGORY = 'COMPUTER HARDWARE AND RELATED FACILITIES' THEN MAIN_CATEGORY_C = 'MC1001';
IF MAIN_CATEGORY = 'CONSTRUCTION IN PROGRESS' THEN  MAIN_CATEGORY_C = 'MC1002' ;
IF MAIN_CATEGORY = 'FURNITURE, FIXTURES AND VEHICLES' THEN  MAIN_CATEGORY_C = 'MC1003';
IF MAIN_CATEGORY = 'OTHER TANGIBLE ASSETS' THEN  MAIN_CATEGORY_C = 'MC1004' ;
IF MAIN_CATEGORY = 'GOODWILL' THEN  MAIN_CATEGORY_C = 'MC1104';
IF MAIN_CATEGORY = 'OTHER INTANGIBLE ASSETS' THEN  MAIN_CATEGORY_C = 'MC1106';
IF MAIN_CATEGORY = 'BRAND NAMES' THEN  MAIN_CATEGORY_C = 'MC1101';
IF MAIN_CATEGORY = 'CREDIT CARDS' THEN  MAIN_CATEGORY_C = 'MC1102';
IF MAIN_CATEGORY = 'CUSTOMER LISTS' THEN  MAIN_CATEGORY_C = 'MC1103';
IF MAIN_CATEGORY = 'IT DEVELOPMENTS' THEN  MAIN_CATEGORY_C = 'MC1105';
IF MAIN_CATEGORY = 'STABLE FUNDING WITH LOW REMUNERATION' THEN  MAIN_CATEGORY_C = 'MC1107';
IF MAIN_CATEGORY = 'ACCRUAL - OTHER ASSETS' THEN  MAIN_CATEGORY_C = 'MC1301';
IF MAIN_CATEGORY = 'INSURANCE CONTRACTS LINKED TO PENSIONS' THEN  MAIN_CATEGORY_C = 'MC1302';
IF MAIN_CATEGORY = 'INVENTORY' THEN  MAIN_CATEGORY_C = 'MC1303';
IF MAIN_CATEGORY = 'NET ASSETS IN PENSION PLANS' THEN  MAIN_CATEGORY_C = 'MC1304';
IF MAIN_CATEGORY = 'PROVISIONS FOR SECURITISATION FUNDS' THEN  MAIN_CATEGORY_C = 'MC1306';
IF MAIN_CATEGORY = 'REST OTHER ASSETS' THEN  MAIN_CATEGORY_C = 'MC1305';
IF MAIN_CATEGORY = 'TRANSACTIONS IN TRANSIT - OTHER ASSETS' THEN  MAIN_CATEGORY_C = 'MC1307';
IF MAIN_CATEGORY = 'NON-FINANCIAL GUARANTEES GIVEN' THEN  MAIN_CATEGORY_C = 'MC4301';
IF MAIN_CATEGORY = 'OTHER COMMITMENTS GIVEN, REST' THEN  MAIN_CATEGORY_C = 'MC4302';

/*INCORPORADOS OCT24*/
IF MAIN_CATEGORY = 'CURRENT TAX ASSETS' THEN  MAIN_CATEGORY_C = 'MC1201';
IF MAIN_CATEGORY = 'DEFERRED TAX ASSETS' THEN  MAIN_CATEGORY_C = 'MC1202';

IF ACCOUNTING_PORTFOLIO = 'NON-TRADING FINANCIAL ASSETS MANDATORILY AT FAIR VALUE THROUGH PROFIT OR LOSS' THEN ACCOUNTING_PORTFOLIO_C = 'ACPF3';
IF ACCOUNTING_PORTFOLIO = 'FINANCIAL INSTRUMENT DESIGNATED AT FAIR VALUE THROUGH PROFIT OR LOSS' THEN ACCOUNTING_PORTFOLIO_C = 'ACPF4';
IF ACCOUNTING_PORTFOLIO = 'FINANCIAL ASSETS AT FAIR VALUE THROUGH OTHER COMPREHENSIVE INCOME' THEN ACCOUNTING_PORTFOLIO_C = 'ACPF5';
IF ACCOUNTING_PORTFOLIO = 'AMORTISED COST' THEN ACCOUNTING_PORTFOLIO_C = 'ACPF6';
IF ACCOUNTING_PORTFOLIO = 'HEDGE ACCOUNTING' THEN ACCOUNTING_PORTFOLIO_C = 'ACPF7';
IF ACCOUNTING_PORTFOLIO = 'HELD FOR TRADING' THEN ACCOUNTING_PORTFOLIO_C = 'ACPF2';
IF ACCOUNTING_PORTFOLIO = 'CASH AND CASH BALANCES AT CENTRAL BANKS AND OTHER DEMAND DEPOSITS' THEN ACCOUNTING_PORTFOLIO_C = 'ACPF1';

IF SECTOR = 'GENERAL GOVERNMENTS' THEN SECTOR_C = 'SC0301';
IF SECTOR = 'OTHER FINANCIAL CORPORATION' THEN SECTOR_C = 'SC0302';
IF SECTOR = 'NON FINANCIAL CORPORATION' THEN SECTOR_C = 'SC0303';
IF SECTOR = 'HOUSEHOLDS' THEN SECTOR_C = 'SC0304';
IF SECTOR = 'CREDIT INSTITUTIONS' THEN SECTOR_C = 'SC02';
IF SECTOR = 'CENTRAL BANKS' THEN SECTOR_C = 'SC01';

IF ASSETS_ORIGIN = 'FORECLOSED/DATION IN PAYMENT' THEN ASSETS_ORIGIN_C = 'ORIG4';
IF ASSETS_ORIGIN ='PURCHASE' THEN ASSETS_ORIGIN_C = 'ORIG1';
IF ASSETS_ORIGIN ='FINANCE LEASE' THEN ASSETS_ORIGIN_C = 'ORIG2';
IF ASSETS_ORIGIN ='OPERATING LEASE' THEN ASSETS_ORIGIN_C = 'ORIG3';  

IF COLLATERAL = 'NO COLLATERAL REAL' THEN COLLATERAL_C = 'COLL1';
IF COLLATERAL = 'REAL ESTATE. RESIDENTIAL' THEN COLLATERAL_C = 'COLL2';
IF COLLATERAL = 'REAL ESTATE. COMMERCIAL' THEN COLLATERAL_C = 'COLL3';
IF COLLATERAL = 'OTHER REAL COLLATERAL' THEN COLLATERAL_C = 'COLL4';

IF TYPE_OF_VALUE IN ('GROSS','NOMINAL','ACCRUED INTEREST','TRANSACTION COSTS','PREMIUM/DISCOUNT','MICROHEDGE ADJUSTMENT','REST FAIR VALUE ADJUSTMENT THROUGH P&L','FAIR VALUE ADJUSTMENT VS OCI') THEN DO; TYPE_OF_VALUE = 'GROSS'; TYPE_OF_VALUE_C = 'TYVA01';END;
IF TYPE_OF_VALUE = 'ACCUMULATED IMPAIRMENT' THEN TYPE_OF_VALUE_C = 'TYVA02';

IF FAIR_VALUE_DETAIL = 'FAIR VALUE GROSS' THEN FAIR_VALUE_DETAIL_C = 'FVAD1';
IF FAIR_VALUE_DETAIL = 'ACCUMULATED NEGATIVE CHANGES IN FAIR VALUE DUE TO CREDIT RISK' THEN FAIR_VALUE_DETAIL_C = 'FVAD2';
IF FAIR_VALUE_DETAIL = 'NON REQUIRED' THEN FAIR_VALUE_DETAIL_C = 'FVAD3';

IF MAIN_CATEGORY NOT IN ('REAL ESTATE',
'COMPUTER HARDWARE AND RELATED FACILITIES',
'CONSTRUCTION IN PROGRESS',
'FURNITURE, FIXTURES AND VEHICLES',
'OTHER TANGIBLE ASSETS') THEN DO; ASSETS_ORIGIN ='N/A'; ASSETS_ORIGIN_C = '';END;

IF MAIN_CATEGORY = 'REAL ESTATE' AND ASSETS_ORIGIN NOT IN ('FORECLOSED/DATION IN PAYMENT',
'PURCHASE',
'FINANCE LEASE',
'OPERATING LEASE') THEN DELETE;

IF MAIN_CATEGORY IN ("LOANS AND ADVANCES","DEBT SECURITIES ACQUIRED") AND SECTOR="CENTRAL BANKS" THEN DO;
	ASSETS_ORIGIN ='N/A'; ASSETS_ORIGIN_C = '';COLLATERAL="N/A";COLLATERAL_C="";FAIR_VALUE_DETAIL="N/A";FAIR_VALUE_DETAIL_C=""; 
END;
IF MAIN_CATEGORY IN  ('LOAN COMMITMENTS GIVEN','OTHER COMMITMENTS GIVEN','OTHER COMMITMENTS GIVEN, REST','NON-FINANCIAL GUARANTEES GIVEN') THEN DO; 
	SECTOR="N/A";SECTOR_C = '';ACCOUNTING_PORTFOLIO='N/A';ACCOUNTING_PORTFOLIO_C = '';ASSETS_ORIGIN ='N/A'; ASSETS_ORIGIN_C = '';COLLATERAL="N/A";COLLATERAL_C="";TYPE_OF_VALUE = "N/A";TYPE_OF_VALUE_C ="";FAIR_VALUE_DETAIL="N/A";FAIR_VALUE_DETAIL_C=""; 
END;
IF MAIN_CATEGORY = "LOANS AND ADVANCES" AND ACCOUNTING_PORTFOLIO="CASH AND CASH BALANCES AT CENTRAL BANKS AND OTHER DEMAND DEPOSITS" THEN DO; 
	ASSETS_ORIGIN ='N/A'; ASSETS_ORIGIN_C = '';COLLATERAL="N/A";COLLATERAL_C="";FAIR_VALUE_DETAIL="N/A";FAIR_VALUE_DETAIL_C=""; 
END;


IF CLASSIFIED_AS_HELD_FOR_SALE = 'OTHER THAN CLASSIFIED AS HELD FOR SALE' AND MAIN_CATEGORY IN ('COMPUTER HARDWARE AND RELATED FACILITIES', 'CONSTRUCTION IN PROGRESS', 'FURNITURE, FIXTURES AND VEHICLES') THEN DO;
	SECTOR="N/A";SECTOR_C = '';ASSETS_ORIGIN ='N/A'; ASSETS_ORIGIN_C = '';COLLATERAL="N/A";COLLATERAL_C="";FAIR_VALUE_DETAIL="N/A";FAIR_VALUE_DETAIL_C=""; 
END;

IF MAIN_CATEGORY = 'DEBT SECURITIES ACQUIRED' AND COLLATERAL NE 'NO COLLATERAL REAL' THEN DO;
	COLLATERAL = 'NO COLLATERAL REAL';COLLATERAL_C = 'COLL1';
END;
IF ACCOUNTING_PORTFOLIO="HELD FOR TRADING" THEN DO;
	SECTOR="N/A";SECTOR_C = '';ASSETS_ORIGIN ='N/A'; ASSETS_ORIGIN_C = '';COLLATERAL="N/A";COLLATERAL_C="";FAIR_VALUE_DETAIL="N/A";FAIR_VALUE_DETAIL_C=""; 
END;
IF SECTOR = "CENTRAL BANKS" THEN DO;
	ASSETS_ORIGIN ='N/A'; ASSETS_ORIGIN_C = '';COLLATERAL="N/A";COLLATERAL_C="";FAIR_VALUE_DETAIL="N/A";FAIR_VALUE_DETAIL_C=""; 
END;

IF MAIN_CATEGORY = "FINANCIAL GUARANTEES GIVEN" THEN DO; CLASSIFIED_AS_HELD_FOR_SALE="N/A";CLASSIFIED_AS_HELD_FOR_SALE_C = "";END;

IF MAIN_CATEGORY = "REAL ESTATE" THEN DO; ACCOUNTING_PORTFOLIO='N/A';ACCOUNTING_PORTFOLIO_C = '';END;
RUN;

DATA sat84_2;
SET sat84;

IF CLASSIFIED_AS_HELD_FOR_SALE_C NE "" THEN COMB1 = CLASSIFIED_AS_HELD_FOR_SALE_C;
ELSE COMvB1 ="";

IF BASE_C NE "" THEN COMB2 = ";"||BASE_C;
ELSE COMB2 ="";
IF BASE_C = 'M01' THEN COMB2 = BASE_C; 

IF MAIN_CATEGORY_C NE "" THEN COMB3 = ";"||MAIN_CATEGORY_C;
ELSE COMB3 ="";

IF ACCOUNTING_PORTFOLIO_C NE "" THEN COMB4 = ";"||ACCOUNTING_PORTFOLIO_C;
ELSE COMB4 ="";

IF SECTOR_C NE "" THEN COMB5 = ";"||SECTOR_C;
ELSE COMB5 ="";

IF ASSETS_ORIGIN_C NE "" THEN COMB6 = ";"||ASSETS_ORIGIN_C;
ELSE COMB6 ="";

IF COLLATERAL_C NE "" THEN COMB7 = ";"||COLLATERAL_C;
ELSE COMB7 ="";

IF TYPE_OF_VALUE_C NE "" THEN COMB8 = ";"||TYPE_OF_VALUE_C;
ELSE COMB8 ="";

IF FAIR_VALUE_DETAIL_C NE "" THEN COMB9 = ";"||FAIR_VALUE_DETAIL_C;
ELSE COMB9 ="";

COMB_ID = COMPRESS(COMB1)||COMPRESS(COMB2)||COMPRESS(COMB3)||COMPRESS(COMB4)||COMPRESS(COMB5)||COMPRESS(COMB6)||COMPRESS(COMB7)||COMPRESS(COMB8)||COMPRESS(COMB9);
RUN;


DATA sat84_3 (DROP = CLASSIFIED_AS_HELD_FOR_SALE_C BASE_C MAIN_CATEGORY_C ACCOUNTING_PORTFOLIO_C SECTOR_C ASSETS_ORIGIN_C COLLATERAL_C TYPE_OF_VALUE_C FAIR_VALUE_DETAIL_C
                COMB1 COMB2 COMB3 COMB4 COMB5 COMB6 COMB7 COMB8 COMB9);
SET sat84_2;
RUN;

/*FILTROS******************************************************************************************/
PROC SQL;
    CREATE TABLE sat84_4 AS
    SELECT *
    FROM sat84_3
    WHERE TYPE_OF_VALUE IN ('GROSS', "N/A") AND MAIN_CATEGORY NE "INVESTMENTS IN SUBSIDIARIES, JOINT VENTURES AND ASSOCIATES" AND SECTOR IN ('CREDIT INSTITUTIONS', 'GENERAL GOVERNMENTS', 'OTHER FINANCIAL CORPORATION', 'NON FINANCIAL CORPORATION', 'HOUSEHOLDS', 'N/A','CENTRAL BANKS') AND
	  FAIR_VALUE_DETAIL IN ('FAIR VALUE GROSS','NON REQUIRED','N/A');
**********************************************************************************************************;
**********************************************************************************************************;
**********************************************************************************************************;
**********************************************************************************************************;
/*PENDIENTE: INCLUIMOS QUE GROSS < 0 y ACC. IMP > 0 eliminar ?*/******************************************;
**********************************************************************************************************;
**********************************************************************************************************;
**********************************************************************************************************;

RUN;

PROC SQL;
   CREATE TABLE sat84_5_2 AS 
   SELECT t1.INFORMING_SOCIETY, 
          t1.Counterparty_Entity, 
          t1.CONTRATO, 
          t1.CLASSIFIED_AS_HELD_FOR_SALE, 
          t1.BASE, 
          t1.MAIN_CATEGORY, 
          t1.ACCOUNTING_PORTFOLIO, 
          t1.SECTOR, 
          t1.ASSETS_ORIGIN, 
          t1.COLLATERAL, 
          t1.TYPE_OF_VALUE, 
          t1.FAIR_VALUE_DETAIL, 
          t1.CINT, 
		  t1.CODPROD,
		  t1.CODSPROD,
		  t1.FECHAPER,
          t1.PAISRE_TIT, 
          t1.CNAE, 
		  t1.SECBES,
          (SUM(t1.AMOUNT)) FORMAT=BEST13. AS AMOUNT, 
          t1.COMB_ID
      FROM WORK.sat84_4 t1
      GROUP BY t1.INFORMING_SOCIETY,
               t1.Counterparty_Entity,
               t1.CONTRATO,
               t1.CLASSIFIED_AS_HELD_FOR_SALE,
               t1.BASE,
               t1.MAIN_CATEGORY,
               t1.ACCOUNTING_PORTFOLIO,
               t1.SECTOR,
               t1.ASSETS_ORIGIN,
               t1.COLLATERAL,
               t1.TYPE_OF_VALUE,
               t1.FAIR_VALUE_DETAIL,
               t1.CINT,
			   t1.CODPROD,
		  	t1.CODSPROD,
		  	t1.FECHAPER,
               t1.PAISRE_TIT,
               t1.CNAE,
			   t1.SECBES,
               t1.COMB_ID;
QUIT;
**AÑADIR DATOS***************************************************************************;
PROC SQL;
CREATE TABLE SAT84_6 AS
SELECT DISTINCT A.*, TIP_PERS, COD_PERS,  G4095_FECHAPER, NACE, NACEL1, NACEL1_CODE, NACE_ESG, NACE_ESG_CODE, LEVEL1, LEVEL2, FLAG_SFCS, KGL5, F_LENDING, ESG_SUB, ESG_SUB_CODE, FLAG_NFRD_GAR, E0623_IDSUBPRD, TIP_PRO, EST_REF, LEI, FLAG_BONOS_BTAR, G4093_CDPOSTAL, G4093_APNOMPER
FROM SAT84_5_2 A LEFT JOIN SAVE.GRANULAR_SCIB_NFRD_OCT24 B
ON A.CONTRATO = B.CONTRATO AND A.CNAE = B.CNAE AND A.CINT = B.CINT AND A.PAISRE_TIT = B.PAISRE_TIT AND A.SECBES = B.SECBES ;
QUIT;

PROC SORT
DATA=WORK.SAT84_6
OUT=WORK.DUPS84/*OUTPUT DATASET WITH DEDUPLICATED RECORD*/
DUPOUT=DUPLICADOS_FUERA NODUPKEY;
BY CONTRATO CINT CNAE SECBES PAISRE_TIT TYPE_OF_VALUE AMOUNT FECHAPER ;
RUN;

**NACES ******************************************************************************************;
DATA NACES;
SET DUPS84;
         IF SECTOR = "OTHER FINANCIAL CORPORATION" THEN DO;
              NACEL1 = ""; NACEL1_CODE = "";
              IF NACE IN ("","N/A") THEN DO NACE_ESG = "6499"; NACE_ESG_CODE = "NACE116499"; END;
              IF SUBSTR(NACE, 1, 2) NOT IN ("64", "65", "66") THEN DO NACE_ESG = "6499"; NACE_ESG_CODE = "NACE116499"; END;
         END;
         ELSE IF SECTOR = "NON FINANCIAL CORPORATION" THEN DO;
              IF NACE IN ("","N/A") THEN DO NACE_ESG = "9499"; NACE_ESG_CODE = "NACE199499"; NACEL1 = "S"; NACEL1_CODE = "CNAEL18"; END;
              IF SUBSTR(NACE, 1, 2) IN ("64", "65", "66") AND NACE NE "6420" THEN DO NACE_ESG = "9499"; NACE_ESG_CODE = "NACE199499"; NACEL1 = "S"; NACEL1_CODE = "CNAEL18"; END;
         END;
         ELSE IF  SECTOR = "HOUSEHOLDS" THEN DO ;
                   NACE_ESG = ""; NACEL1 = ""; NACE = ""; NACEL1_CODE = ""; NACE_ESG_CODE = ""; 
         END;
RUN;

**CSAES*******************************************************************************************;
DATA CSAES;
SET SAVE.EJERCICIO_CSAE;
         CODPER1 = PUT(CODPER, Z9.);   
         CINT = COMPRESS(TIPO)||  COMPRESS(CODPER1);
RUN;

PROC SQL;
         CREATE TABLE CSAES_2 AS   
                   SELECT DISTINCT A.*, B.CSAE
                   FROM NACES A LEFT JOIN CSAES B 
                   ON A.CINT = B.CINT;
QUIT;

PROC SQL;
         CREATE TABLE CSAES_2_1 AS 
                   SELECT DISTINCT A.*, B.NACE AS CSAE_NACE
                   FROM CSAES_2 A LEFT JOIN SAVE.RELACION_NACE_CNAE B 
                   ON A.CSAE = B.CNAE;
QUIT;

DATA CSAES_3;
SET CSAES_2_1 (DROP=CSAE RENAME= CSAE_NACE = CSAE);
         IF CSAE NE "" AND NACE = '6420' AND NACE_ESG = '6420' THEN DO;
                   NACE_ESG_1 = CSAE;
         END;
RUN;

%NACE_CODE(CSAES_3, CSAES_4, NACE_ESG_1, NACE_ESG_CODE_1);

DATA CSAES_5;
SET CSAES_4;
         IF CSAE NE "" AND NACE = '6420' AND NACE_ESG = '6420' THEN DO;
                   NACE_ESG_F = NACE_ESG_1 ;
                   NACE_ESG_CODE_F = NACE_ESG_CODE_1;
         END;
         ELSE DO;
                   NACE_ESG_F = NACE_ESG;
                   NACE_ESG_CODE_F = NACE_ESG_CODE;
         END;

         IF SUBSTR(NACE_ESG_F,1,2) IN ('64','65','66') AND SECTOR = 'NON FINANCIAL CORPORATION' THEN DO;
                   NACE_ESG_F = '9499';
                   NACE_ESG_CODE_F = 'NACE199499';
         END;
RUN;

**ESG SUBSECTOR********************************************************************************;
DATA ESGSUB_TABLA;
SET CSAES_5 (DROP= NACE_ESG RENAME= NACE_ESG_F = NACE_ESG);

FORMAT     ESG_SUBSECTOR $50. ;
FORMAT     ESG_SUBSECTOR_CODE $50. ;

IF SECTOR = "OTHER FINANCIAL CORPORATION" THEN DO;
    IF NACE_ESG IN ("6629", "6622", "6621", "6520", "6512", "6511")   THEN DO ESG_SUBSECTOR = "INSURANCE UNDERTAKINGS"; ESG_SUBSECTOR_CODE = "ESGS5"; END;
    ELSE IF NACE_ESG IN ( "6619", "6420")  THEN DO ESG_SUBSECTOR = "MANAGEMENT COMPANIES"; ESG_SUBSECTOR_CODE = "ESGS4"; END;
     ELSE IF NACE_ESG IN ("6630", "6612", "6430", "6611", "6530") THEN DO ESG_SUBSECTOR = "INVESTMENT FIRMS"; ESG_SUBSECTOR_CODE = "ESGS3"; END;
     ELSE DO ESG_SUBSECTOR = "REST OF OTHER FINANCIAL CORPORATION"; ESG_SUBSECTOR_CODE = "ESGS6"; END;
END;
ELSE IF SECTOR = "GENERAL GOVERNMENTS" THEN DO; 
     IF ESG_SUB NE "" THEN DO;
          ESG_SUBSECTOR = ESG_SUB; ESG_SUBSECTOR_CODE = ESG_SUB_CODE; END;
     ELSE DO ESG_SUBSECTOR = "SOVEREIGNS"; ESG_SUBSECTOR_CODE = "ESGS2"; END; 
END;
ELSE DO;
     ESG_SUBSECTOR = "N/A";
     ESG_SUBSECTOR_CODE = "N/A";
END;
/*LEI CLASIFICADOS COMO SOVEREIGN QUE DEBERÍAN SER LOCAL GOV.*/
IF SECTOR = 'GENERAL GOVERNMENTS' AND LEI IN ('5493002OG1USXVKGSZ04',
'9598000KQHFX2BBJ0T57',
'9598005X66Q2C11GB613',
'549300ORQAC7SU2XEX96',
'959800S9ZS41HKL6PL20',
'959800LV0700UVC5TD51',
'549300ONJB7H54LG1013',
'95980020140005732295',
'959800HK1UDR6LGRJ095',
'95980020140005978093',
'5493007QRK5KLVRZ4E62',
'95980020140005545764',
'959800XECKW6NGB8EP63',
'95980020140005397063',
'959800KY4UQV68000N51',
'959800TK19RUCXJ4MM39',
'9598005KTKRXVXFUZL08',
'95980020140005773908',
'959800HA3AQJ7K8XQL52',
'549300QZ5XA0H77DT662',
'9598000H54PYRAA4RB19',
'9598001C9DU6053CEC51',
'95980020140005480289',
'95980088W7L5FHUAPU65',
'9598005UWTLJ58XDT733',
'95980020140005480192',
'95980027GYGQGGUS5U58',
'959800RZE7FR4XTZDT77',
'9598000CCKAZAN5J9M02',
'959800U57QH7B2MXJD69',
'959800JX7D3A6VK3J673',
'959800Q7L3GT7Y7UQN63',
'9598004UC8QPDS0LK969',
'5493008NLSX7R4U1SE80',
'959800KZF5ERFQVTR028',
'959800KQ48AD8255C704',
'959800NLYN5HCV18W025',
'549300HU1TEGNYORRI75',
'95980020140005739570',
'959800SCQ8HEXKCKJP84',
'959800DV3L8CU2FBQD68',
'95980020140005176194',
'959800TDJ7SUX2S6W520',
'95980075NB7YQ7YZRA94',
'95980020140005025844',
'959800JB8XDVX4F2R984',
'95980020140005881772',
'959800R1S2UDHD7MGU49',
'95980041ECCYMGFY2C52',
'95980020140005725893',
'9845006E8C3CPG1I0689',
'95980020140005679818',
'5493008KJZ5JMIMMH857',
'959800VM5FSFZDYLL681',
'959800UQNPLNP9QNKR23',
'959800DZCWTY4AA2LQ22',
'959800P8FTMEU9W9ZW82',
'959800MMC4YY4P61SR28',
'9598004DLGCE98MJYP48',
'959800C0ZH3CTKRB0M57',
'9598006JJJ1S74BBBK86',
'959800YYLZWV7GSY6J54',
'959800BH03779BTVN106',
'959800FGEYWYQAD6LZ30',
'959800T58WL5EBPS0R15',
'9598002VTXM7C7P7FK63',
'959800DZTNRDRWCWK346',
'95980020140005136909',
'549300K1ZBVGDDE6CX52',
'959800ST23KF02K6U828',
'984500EH3QA1Z1399665',
'959800LRYQK4XC9QU506',
'959800YCM31S95CTT797',
'959800QU6GAUA11CG942',
'5493001AYNSRONVPUP95',
'959800D8PJH4S1KJFU55',
'549300HA3G58354Q5G98',
'549300G7IARDMI1RT133',
'95980020140005626565',
'959800FEHH2MTRVAU835',
'549300SBGL5SCFDMO230',
'959800FJMZTBMTJTXZ02',
'959800USU7GP2A6YUK63',
'959800ZGDP54GN3XJY03',
'959800AVHJVLBLFBK756',
'95980020140005890211',
'959800VEMVYC6Z1N1278',
'959800Q15UNGZYPZYX62',
'959800DKVUB7B2JWUL69') then do;
	ESG_SUBSECTOR = "LOCAL GOVERNMENTS"; ESG_SUBSECTOR_CODE = "ESGS1";
END;
IF SECTOR NOT IN ('GENERAL GOVERNMENTS','OTHER FINANCIAL CORPORATION') THEN DO; 
	ESG_SUBSECTOR = "N/A"; ESG_SUBSECTOR_CODE = "N/A";
END;
IF SECTOR NE 'GENERAL GOVERNMENTS' AND ESG_SUBSECTOR IN ("SOVEREIGNS","LOCAL GOVERNMENTS") THEN DO;
	ESG_SUBSECTOR = "N/A"; ESG_SUBSECTOR_CODE = "N/A";
END;
RUN; 

**CHRONIC Y ACUTE********************************************************************************;
/*NACE para cruce*/
DATA NACE_CRUCE;
SET ESGSUB_TABLA;
NACEL2 = SUBSTR(NACE_ESG_F,1, 2);
IF NACEL2 IN ("01", "02", "03") THEN DO NACEL1_79 = "A";  END;
ELSE IF NACEL2 IN ("05", "06", "07", "08", "09") THEN DO NACEL1_79 = "B"; END;
ELSE IF NACEL2 IN ("10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33") THEN DO NACEL1_79 = "C";  END;
ELSE IF NACEL2 = "35" THEN DO NACEL1_79 = "D";  END;
ELSE IF NACEL2 IN ("36", "37", "38", "39") THEN DO NACEL1_79 = "E";  END;
ELSE IF NACEL2 IN ("41", "42", "43") THEN DO NACEL1_79 = "F";   END;
ELSE IF NACEL2 IN ("45", "46", "47") THEN DO NACEL1_79 = "G"; END;
ELSE IF NACEL2 IN ("49", "50", "51", "52", "53") THEN DO NACEL1_79 = "H";  END;
ELSE IF NACEL2 IN ("55", "56") THEN DO NACEL1_79 = "I";   END;
ELSE IF NACEL2 IN ("58", "59", "60", "61", "62", "63") THEN DO NACEL1_79 = "J";   END;
ELSE IF NACEL2 IN ("64", "65", "66") THEN DO NACEL1_79 = "K"; END; /*Como se dijo en la reunión asignamos el NACEL1 K a S*/
ELSE IF NACEL2 = "68" THEN DO NACEL1_79 = "L";  END;
ELSE IF NACEL2 IN ("69", "70", "71", "72", "73", "74", "75") THEN DO NACEL1_79 = "M";  END;
ELSE IF NACEL2 IN ("77", "78", "79", "80", "81", "82") THEN DO NACEL1_79 = "N";  END;
ELSE IF NACEL2 = "84" THEN DO NACEL1_79 = "O";  END;
ELSE IF NACEL2 = "85" THEN DO NACEL1_79 = "P";  END;
ELSE IF NACEL2 IN ("86", "87", "88") THEN DO NACEL1_79 = "Q";   END;
ELSE IF NACEL2 IN ("90", "91", "92", "93") THEN DO NACEL1_79 = "R";   END;
ELSE IF NACEL2 IN ("94", "95", "96") THEN DO NACEL1_79 = "S";   END;
ELSE IF NACEL2 IN ("97", "98") THEN DO NACEL1_79 = "T";  END; /*Como se dijo en la reunión asignamos el NACEL1 T a S*/
ELSE IF NACEL2 IN ("99") THEN DO NACEL1_79 = "U";  END;/*Como se dijo en la reunión asignamos el NACEL1 U a S*/
RUN; 

DATA RISK;
SET NACE_CRUCE;
format NACE_CRUCE $9. ;
NACE_CRUCE = COMPRESS(NACEL1_79)||"."||COMPRESS(SUBSTR(NACE_ESG_f, 1, 2));
IF NACE_ESG_f = "" THEN NACE_CRUCE = "";
RUN;

* Definición de Secured;
DATA RISK2;
SET RISK;
FORMAT NACE_CRUCE $9.;
IF /*(SECTOR = "HOUSEHOLDS" OR SECTOR = "NON FINANCIAL CORPORATION" OR SECTOR = "OTHER FINANCIAL CORPORATION") AND*/ COLLATERAL IN ("REAL ESTATE. COMMERCIAL", "REAL ESTATE. RESIDENTIAL") /*AND TYPE_OF_VALUE = "GROSS" AND FAIR_VALUE_DETAIL NE "ACCUMULATED NEGATIVE CHANGES IN FAIR VALUE DUE TO CREDIT RISK" */ THEN DO NACE_CRUCE = "Secured"; END;
/*ELSE IF MAIN_CATEGORY = "REAL ESTATE" AND TYPE_OF_VALUE = "GROSS" AND FAIR_VALUE_DETAIL NE "ACCUMULATED NEGATIVE CHANGES IN FAIR VALUE DUE TO CREDIT RISK" THEN DO NACE_CRUCE = "Secured"; END;*/
RUN;

DATA RISK3_SECURED;
SET RISK2 (WHERE = (NACE_CRUCE = 'Secured'));
RUN;

DATA RISK3_NO_SECURED;
SET RISK2 (WHERE = (NACE_CRUCE NE 'Secured'));
FORMAT NUTS_CRUCE $10.;
       NUTS_CRUCE = NUTS3_COUNTERPARTY;
RUN;

**PEGO LOS DATOS DE EPCS PARA LA ELEGIBILIDAD DE HIPOTECAS*********;
PROC SQL;
CREATE TABLE EPCS_TABLA AS
SELECT DISTINCT A.*, EPC_LABEL_DATA, EPC_LABEL_DATA_CD, EPC_LABEL, EPC_LABEL_CODE, emission_factor AS THRESHOLD, idcatast, g4124_biengar1 as id_garant, G4091_CODPOSGR,G4134_IMGARANT, NUTS3_COLLATERAL, Clasificacion_final, anoedifi, NUMBIEN
FROM RISK3_SECURED A LEFT JOIN (select * from SAVE.garantia_contrato_NTS_EPCs_OCT24 where NUTS3_COLLATERAL ne "" AND G4124_COD_GAR2 in (030309, 030330, 030340, 030709,30310,29,30629,18)) B
ON A.CONTRATO = B.CONTRATO;
QUIT;

PROC SORT
DATA=work.EPCS_TABLA 
OUT=EPCS_TABLA_SINDUPS
DUPOUT=DU_FUERA NODUPKEY;
BY CONTRATO ID_GARANT G4134_IMGARANT SECTOR;
RUN;
**PONDERACIONES GROSS***************************************************************************;
* Se calcula la suma de Gross por CONTRATO, cint, cnae, paisre_tit, accounting_portfolio ,collateral; 
PROC SQL;
CREATE TABLE EPCS_TABLA2 AS
SELECT DISTINCT CONTRATO, cint, cnae, paisre_tit,  secbes, COLLATERAL, SECTOR, ACCOUNTING_PORTFOLIO, Sum(AMOUNT) AS GROSS_CONTRATO
FROM (SELECT DISTINCT CONTRATO, cint, cnae, paisre_tit, secbes, COLLATERAL, SECTOR, ACCOUNTING_PORTFOLIO, AMOUNT FROM EPCS_TABLA_SINDUPS)
GROUP BY CONTRATO, cint, cnae, paisre_tit, secbes, COLLATERAL, ACCOUNTING_PORTFOLIO, SECTOR;
QUIT;

PROC SQL;
CREATE TABLE EPCS_TABLA3 AS
SELECT a.*, B. GROSS_CONTRATO
FROM EPCS_TABLA_SINDUPS  A LEFT JOIN  EPCS_TABLA2 B 
ON A.CONTRATO = B.CONTRATO and a.cint = b.cint and a.paisre_tit = b.PAISRE_TIT AND A.CNAE = B.CNAE AND 
A.SECBES = B.SECBES AND A.COLLATERAL=B.COLLATERAL AND A.ACCOUNTING_PORTFOLIO = B.ACCOUNTING_PORTFOLIO AND A.SECTOR = B.SECTOR;
RUN;

* Se calcula la suma de las garantías por CONTRATO, cint, cnae, paisre_tit, accounting_portfolio, collateral, GROSS_CONTRATO;
PROC SQL;
CREATE TABLE EPCS_TABLA4 AS
SELECT DISTINCT *, sum(G4134_IMGARANT) as SUM_VAL_GARA
FROM EPCS_TABLA3  
group by CONTRATO, cint, cnae, paisre_tit, SECBES, GROSS_CONTRATO , COLLATERAL, ACCOUNTING_PORTFOLIO, SECTOR ;
RUN;

proc sql;
     create table EPCS_TABLA5 as
     select *, count(contrato) as num_garanti
     from EPCS_TABLA4
     group by contrato, cint, cnae, paisre_tit, SECBES, COLLATERAL, ACCOUNTING_PORTFOLIO, SECTOR ;
run;
* Se calcula el gross ponderado a partir de GROSS_CONTRATO y SUM_VAL_GARA;
DATA EPCS_TABLA6 (drop= AMOUNT rename= gross_ponderado = AMOUNT);
SET EPCS_TABLA5;
FORMAT GROSS_PONDERADO 18.2;
FORMAT NUTS_CRUCE $6.;
FORMAT PAIS_CRUCE $3.;

PAIS_CRUCE="ES";

factor = G4134_IMGARANT / SUM_VAL_GARA;
if factor in (.) and G4134_IMGARANT= (.) and id_garant ne (.) then factor2 = (.); 
else if factor in (.) then factor2 = 1/num_garanti; else factor2 = factor;
GROSS_PONDERADO = GROSS_CONTRATO * factor2;
if id_garant = . then GROSS_PONDERADO = AMOUNT;

run;

DATA RISK3_NO_SECURED1;
SET RISK3_NO_SECURED;
FORMAT PAIS_CRUCE $3.;

IF PAISRE_TIT = "GB"  THEN PAIS_CRUCE = "UK";
ELSE IF PAIS_CRUCE = "" THEN DO;
	IF PAISRE_TIT NE "" THEN PAIS_CRUCE=PAISRE_TIT;
	ELSE PAIS_CRUCE="ES";
END; 
RUN;

/*** PHYSICAL RISK ***/
/**CONTRATOS SECURED**/
/* 1º CRUCE CON EL FICHERO EXTERNO POR CODIGO POSTAL ASUMIENDO QUE EL PAIS DEL COLATERAL ES SIEMPRE ESPAÑA - */
/* CRUCE POR CODIGO POSTAL DEL COLATERAL*/
PROC SQL;
CREATE TABLE PHYSCL_RSK_CP_COL AS
SELECT DISTINCT A.*, B.RS_CHRONIC AS CHRONIC_CP_GARANT, B.RS_ACUTE AS ACUTE_CP_GARANT
FROM EPCS_TABLA6 A LEFT JOIN SAVE.PHYSICAL_RISK_ESP_CP B
ON A.G4091_CODPOSGR= SUBSTR(B.LOCATION,5,5) AND A.NACE_CRUCE=B.NACE;
QUIT;
/* 2º EN CASO DE NO HABER CRUZADO, CRUCE CON NUTS*/
PROC SQL;
CREATE TABLE RISK4_SECURED AS
SELECT DISTINCT A.*, B.RS_CHRONIC AS CHRONIC_NUTS_GARANT, B.RS_ACUTE AS ACUTE_NUTS_GARANT
FROM PHYSCL_RSK_CP_COL A LEFT JOIN SAVE.PHYSICAL_RISK_DIC24 B
ON A.NACE_CRUCE= B.NACE AND a.NUTS_CRUCE= B.LOCATION AND A.PAIS_CRUCE = B.COUNTRY;
QUIT; 

/* 2º EN CASO DE NO HABER CRUZADO, CRUCE CON PROXY PAÍS*/
PROC SQL;
CREATE TABLE RISK4_1 AS
SELECT DISTINCT A.*, B.RS_CHRONIC AS CHRONIC_PROXY_GARANT, B.RS_ACUTE AS ACUTE_PROXY_GARANT
FROM RISK4_SECURED A LEFT JOIN SAVE.PHYSICAL_RISK_CNTRY_DIC24 B
ON A.NACE_CRUCE= B.NACE AND A.PAIS_CRUCE = B.COUNTRY;
QUIT;
/*ASIGNAMOS ORDEN DE PRELACION: 1º CODIGO POSTAL, 2º PROXY PAIS*/
DATA RISK5;
SET RISK4_1;
format CHRONIC ACUTE $3.;

IF CHRONIC_CP_GARANT NE "" THEN CHRONIC = PUT(CHRONIC_CP_GARANT, 3.);
ELSE IF CHRONIC_NUTS_GARANT NE ""  THEN CHRONIC = PUT(CHRONIC_NUTS_GARANT, 3.);
ELSE IF CHRONIC_PROXY_GARANT NE "" THEN CHRONIC = PUT(CHRONIC_PROXY_GARANT, 3.);


IF ACUTE_CP_GARANT NE "" THEN ACUTE = PUT(ACUTE_CP_GARANT, 3.);
ELSE IF ACUTE_NUTS_GARANT NE "" THEN ACUTE = PUT(ACUTE_NUTS_GARANT, 3.);
ELSE IF ACUTE_PROXY_GARANT NE ""  THEN ACUTE = PUT(ACUTE_PROXY_GARANT, 3.);
RUN;

/**CONTRATOS UNSECURED**/
/* 1º CRUCE POR CODIGO POSTAL*/
PROC SQL;
CREATE TABLE PHYSCL_RSK_CP_CLIE AS
SELECT DISTINCT A.*, B.RS_CHRONIC AS CHRONIC_CP_CLIE, B.RS_ACUTE AS ACUTE_CP_CLIE
FROM RISK3_NO_SECURED1 A LEFT JOIN SAVE.PHYSICAL_RISK_ESP_CP B
ON A.G4093_CDPOSTAL= SUBSTR(B.LOCATION,5,5) AND A.NACE_CRUCE=B.NACE ;
QUIT;
/* 2º EN CASO DE NO HABER CRUZADO, CRUCE CON NUTS*/
PROC SQL;
CREATE TABLE RISK4 AS
SELECT DISTINCT A.*, B.RS_CHRONIC AS CHRONIC_NUTS_CLIE, B.RS_ACUTE AS ACUTE_NUTS_CLIE
FROM PHYSCL_RSK_CP_CLIE A LEFT JOIN SAVE.PHYSICAL_RISK_DIC24 B
ON A.NACE_CRUCE= B.NACE AND a.NUTS_CRUCE= B.LOCATION AND A.PAIS_CRUCE = B.COUNTRY;
QUIT;
/*3º CRUCE POR PROXY PAIS*/
PROC SQL;
CREATE TABLE PROXY_PAIS AS
SELECT DISTINCT A.*, B.RS_CHRONIC AS CHRONIC_PROXY_CLIE, B.RS_ACUTE AS ACUTE_PROXY_CLIE
FROM RISK4 A LEFT JOIN SAVE.PHYSICAL_RISK_CNTRY_DIC24 B
ON A.NACE_CRUCE= B.NACE AND A.PAIS_CRUCE = B.COUNTRY;
QUIT;
/*ASIGNAMOS ORDEN DE PRELACION: 1º CODIGO POSTAL, 2º NUTS SI NO ES ESPAÑA,3º PROXY PAIS*/
DATA RISK_5_B;
SET PROXY_PAIS;
format CHRONIC ACUTE $3.;

IF CHRONIC_CP_CLIE NE "" AND PAISRE_TIT="ES" THEN CHRONIC = PUT(CHRONIC_CP_CLIE, 3.);
ELSE IF CHRONIC_NUTS_CLIE NE ""  THEN CHRONIC = PUT(CHRONIC_NUTS_CLIE, 3.);
ELSE IF CHRONIC_PROXY_CLIE NE "" THEN CHRONIC = PUT(CHRONIC_PROXY_CLIE, 3.);

IF ACUTE_CP_CLIE NE "" AND PAISRE_TIT="ES" THEN ACUTE = PUT(ACUTE_CP_CLIE, 3.);
ELSE IF ACUTE_NUTS_CLIE NE "" THEN ACUTE = PUT(ACUTE_NUTS_CLIE, 3.);
ELSE IF ACUTE_PROXY_CLIE NE "" THEN ACUTE = PUT(ACUTE_PROXY_CLIE, 3.);
RUN;

DATA RISK3;
SET RISK5 RISK_5_B;
RUN;

/*Si no cruza-> No por defecto*/
DATA RISK6;
SET RISK3;
format CHRONIC ACUTE $3.;
format CHRONIC_CODE ACUTE_CODE $5.;

IF ACUTE = "" THEN ACUTE = "No";
IF CHRONIC = "" THEN CHRONIC = "No";
IF ACUTE = "Yes" THEN ACUTE_CODE= "ACUT1";
ELSE IF ACUTE = "No" THEN ACUTE_CODE= "ACUT2";
IF CHRONIC = "Yes" THEN CHRONIC_CODE= "CHRO1";
ELSE IF CHRONIC = "No" THEN CHRONIC_CODE= "CHRO2";
RUN;

**PEGO LOS DATOS DE ZONA CLIMÁTICA PARA LA ELEGIBILIDAD DE HIPOTECAS*********;
/*ZONA CLIMÁTICA JUN24 - ID CATASTRAL*/
PROC SQL;
CREATE TABLE ZONA_CLIMATICA_TABLA AS
SELECT DISTINCT *
FROM RISK6 A LEFT JOIN SAVE.ZONA_CLIMATICA_JUN24 B  
ON A.idcatast = B.ID_CATASTRAL;
QUIT;
/*ZONA CLIMÁTICA OCT24 - NUMBIEN*/
PROC SQL;
CREATE TABLE ZONA_CLIMATICA_NUMBIEN AS
SELECT DISTINCT A.*,B.ZONA_CLIMATICA AS ZONA_CLIMATICA_NUMBIEN
FROM ZONA_CLIMATICA_TABLA A LEFT JOIN SAVE.ZONA_CLIMATICA_NUMBIEN_OCT24 B  
ON A.NUMBIEN = B.NUMBIEN;
QUIT;

**PURPOSE ESG**********************************************************************************;
DATA PESG_TABLA;
SET ZONA_CLIMATICA_TABLA;

FORMAT     PURPOSE_ESG $50. ;
FORMAT     PURPOSE_ESG_CODE $50. ;
 
/*MOTOR VEHICLE LOANS*/
/*No permite la combinacion COLL2 o COLL3 + Motor Vehicle Loans*/
/*Consumo*/
	 /*Actividad Green Dashboard*/
IF COLLATERAL NOT IN ('REAL ESTATE. COMMERCIAL','REAL ESTATE. RESIDENTIAL') THEN DO;
 	IF LEVEL1 IN ("PRÉSTAMOS VEHÍCULOS A MOTOR","PRESTAMOS VEHICULOS A MOTOR","GROUND TRANSPORT","1. MOTOR VEHICLE LOANS") 
		OR LEVEL2 IN ("PRÉSTAMOS VEHÍCULOS A MOTOR","PRESTAMOS VEHICULOS A MOTOR","GROUND TRANSPORT","1. MOTOR VEHICLE LOANS") 
		OR ACTIVIDAD_SFCS IN ("2.1 LAND TRANSPORT", "2.1 LAND TRANSPORT") THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
	END;
	 /*Producto y subproducto*/
	IF CODPROD = "143" AND CODSPROD = "542" AND EST_REF IN ("0000085","0000099","0000114","0000115") THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
	END;
	IF CODPROD = "143" AND CODSPROD = "538" AND EST_REF IN ("0000013") THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
	END;
	IF CODPROD = "123" AND CODSPROD = "337" AND EST_REF IN ("0000001","0000002") THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
	END;
	IF CODPROD = "103" AND CODSPROD = "716" AND EST_REF IN ("0000040","0000041") THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
	END;
	/*Finalidades*/
	IF tipo_fina_prop IN ("C2", "F9", "M6", "76", "81", "82", "83", "84") THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
	END;
/*LyR*/
	/*Producto y subproducto*/
	IF CODPROD = "750" AND CODSPROD IN (1, 506) THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
    END;
	IF CODPROD = "150" AND CODSPROD = "1" THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
    END;
	IF CODPROD = "153" AND CODSPROD = "12" THEN DO;
		PURPOSE_ESG = "MOTOR VEHICLE LOANS"; PURPOSE_ESG_CODE = "PESG2";
    END;
END;
/*BUILDING ACQUISITIONS*/
	/*HH*/
	IF SECTOR = "HOUSEHOLDS" AND  COLLATERAL = 'REAL ESTATE. RESIDENTIAL' THEN DO;
			PURPOSE_ESG = "BUILDING ACQUISITION LOANS"; PURPOSE_ESG_CODE = "PESG3";
	END;
	/*NFC*/
	IF SECTOR IN ("NON FINANCIAL CORPORATION", "OTHER FINANCIAL CORPORATION", "CREDIT INSTITUTIONS") AND COLLATERAL IN ('REAL ESTATE. COMMERCIAL', 'REAL ESTATE. RESIDENTIAL') THEN DO;
			PURPOSE_ESG = "BUILDING ACQUISITION LOANS"; PURPOSE_ESG_CODE = "PESG3";
	END;
	/*GENERAL GOV.*/
	IF SECTOR = "GENERAL GOVERNMENTS" AND ESG_SUBSECTOR="LOCAL GOVERNMENTS" AND COLLATERAL IN ('REAL ESTATE. COMMERCIAL','REAL ESTATE. RESIDENTIAL') THEN DO;
			PURPOSE_ESG = "BUILDING ACQUISITION LOANS"; PURPOSE_ESG_CODE = "PESG3";
	END;
/*BUILDING RENOVATIONS*/
	/*SOLO APLICA A HH Y NFC*/
	IF SECTOR IN ("HOUSEHOLDS","NON FINANCIAL CORPORATION") AND (ACTIVIDAD_SFCS IN ('A.3.2 RENOVATION OF EXISTING BUILDINGS',
	'RENOVATION OF EXISTING BUILDINGS',"5.1 CONSTRUCTION, REFURBISHMENT AND PURCHASE OF GREEN BUILDINGS", "5.1 GREEN BUILDINGS","5.2 ENERGY EFFICIENCY EQUIPMENT IN BUILDINGS","5.3. RENEWABLE ENERGY INFRASTRUCTURE IN BUILDINGS","5.4. INSTRUMENTS AND DEVICES TO ENHANCE BUILDINGS ENERGY USE",'5.1 CONSTRUCTION, REFURBISHMENT AND PURCHASE OF GREEN BUILDINGS',"5.1 GREEN BUILDINGS","5.2 ENERGY EFFICIENCY EQUIPMENT IN BUILDINGS","5.3. RENEWABLE ENERGY INFRASTRUCTURE IN BUILDINGS",'5.4. INSTRUMENTS AND DEVICES TO ENHANCE BUILDINGS ENERGY USE','CONSTRUCTION, ACQUISITION, AND RENOVATION OF BUILDINGS', 'ENERGY EFFICIENCY EQUIPMENT IN BUILDINGS',
	'CONSTRUCTION AND MAINTENANCE OF OTHER STRUCTURES') OR LEVEL1 = "BUILDING RENOVATION LOANS" OR LEVEL2 IN ("PRÉSTAMOS PARA RENOVACIÓN DE VIVIENDAS","PRESTAMOS PARA RENOVACION DE VIVIENDAS", "CONSTRUCTION REFURBISHMENT OR PURCHASE OF GREEN BUILDINGS","ENERGY EFFICIENCY EQUIPMENT INSTRUMENTS AND DEVICES TO IMPROVE ENERGY PERFORMANCE OF BUILDINGS","RENEWABLE ENERGY INFRASTRUCTURE IN BUILDINGS")) THEN DO;
		PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;
	IF CODPROD = "143" AND CODSPROD = "542" AND EST_REF IN ("0000101","0000118","0000120","0000121","0000129") THEN DO;
		PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;

	IF CODPROD = "123" AND CODSPROD = "346" AND EST_REF IN ("0000001","0000002") THEN DO;
			PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;
	IF CODPROD = "103" AND CODSPROD = "737" AND EST_REF IN ("0000011") THEN DO;
			PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;
	IF CODPROD = "103" AND CODSPROD = "508" AND EST_REF IN ("0000019") THEN DO;
			PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;
	IF CODPROD = "143" AND CODSPROD = "512" AND EST_REF IN ("0000049","0000050","0000052") THEN DO;
			PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;
	IF CODPROD = "123" AND CODSPROD = "651" AND EST_REF IN ("0000054","0000066") THEN DO;
			PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;
	/*Préstamo Powen (no sale en el catalogo porque se cancelo en 2022*/
	IF CODPROD = "142" AND CODSPROD = "513" AND EST_REF IN ("0000021") THEN DO;
			PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;
	/*FINALIDAD */
	IF tipo_fina_prop IN ("C6", "F8", "X1", "05", "16", "41") THEN DO;
			PURPOSE_ESG = "BUILDING RENOVATION LOANS"; PURPOSE_ESG_CODE = "PESG1"; 
	END;
/*END;*/
/*OTHER PURPOSE*/
IF LEVEL1 IN ('1.1 RENEWABLE ENERGY PRODUCTION'
				'1.3. TRANSMISSION AND DISTRIBUTION OF ELECTRICITY'
				'2.4 TRANSPORT INFRASTRUCTURE','RENEWABLE ENERGY PRODUCTION'
				'TRANSMISSION AND DISTRIBUTION OF ELECTRICITY'
				'TRANSPORT INFRASTRUCTURE','1.1 RENEWABLE ENERGY GENERATION','RENEWABLE ENERGY GENERATION','DISTRIBUTION AND TRANSMISSION OF ELECTRICITY, GAS AND HEAT/COOL',
				'DISTRIBUTION AND TRANSMISSION OF ELECTRICITY, GAS AND HEAT/COOL','CIVIL ENGINEERING GROUND WATER AND UTILITY PROJECTS') 
	OR LEVEL2 IN ('1.1 RENEWABLE ENERGY PRODUCTION'
				'1.3. TRANSMISSION AND DISTRIBUTION OF ELECTRICITY'
				'2.4 TRANSPORT INFRASTRUCTURE','RENEWABLE ENERGY PRODUCTION'
				'TRANSMISSION AND DISTRIBUTION OF ELECTRICITY'
				'TRANSPORT INFRASTRUCTURE','1.1 RENEWABLE ENERGY GENERATION','RENEWABLE ENERGY GENERATION','DISTRIBUTION AND TRANSMISSION OF ELECTRICITY, GAS AND HEAT/COOL','CIVIL ENGINEERING GROUND WATER AND UTILITY PROJECTS') THEN DO;
	PURPOSE_ESG = "OTHER PURPOSE"; PURPOSE_ESG_CODE = "PESG4";
END;
IF PURPOSE_ESG = "" THEN DO;
	PURPOSE_ESG = "OTHER PURPOSE"; PURPOSE_ESG_CODE = "PESG4";
END;
RUN;

**GENERAL Y SPECIFIC***************************************************************************;
DATA G_S_TABLA  ;
SET PESG_TABLA;
FORMAT GS_PURPOSE GS_PURPOSE_CODE $50.;

GS_PURPOSE = "General Purpose";	GS_PURPOSE_CODE = "GSPUR1";

/*SPECIFIC PURPOSE*/
/*BUILDING ACQUISITIONS*/
/*Households, NFC, OFC, CI */
IF SECTOR IN ("HOUSEHOLDS","NON FINANCIAL CORPORATION", "OTHER FINANCIAL CORPORATION", "CREDIT INSTITUTIONS") AND PURPOSE_ESG = "BUILDING ACQUISITION LOANS" THEN DO;
	GS_PURPOSE = "Specific Purpose"; GS_PURPOSE_CODE = "GSPUR2";
END;
/*Housing financing*/
IF SECTOR = "GENERAL GOVERNMENTS" THEN DO;
	IF ESG_SUBSECTOR = "LOCAL GOVERNMENTS" AND PURPOSE_ESG = "BUILDING ACQUISITION LOANS" THEN DO;
		GS_PURPOSE = "Specific Purpose"; GS_PURPOSE_CODE = "GSPUR2";
	END;
END;
/*BUILDING RENOVATION LOANS - SOLO APLICA A HH + NFC*********************************************************************************;
	/*IDENTIFICACIÓN POR PRODUCTOS*/
IF SECTOR IN ("HOUSEHOLDS","NON FINANCIAL CORPORATION") AND PURPOSE_ESG = "BUILDING RENOVATION LOANS" THEN DO;
	GS_PURPOSE = "Specific Purpose"; GS_PURPOSE_CODE = "GSPUR2";
END;
/*MOTOR VEHICLE LOANS*/
IF SECTOR IN ("HOUSEHOLDS","NON FINANCIAL CORPORATION", "OTHER FINANCIAL CORPORATION", "CREDIT INSTITUTIONS") AND PURPOSE_ESG = "MOTOR VEHICLE LOANS" THEN DO;
	GS_PURPOSE = "Specific Purpose"; GS_PURPOSE_CODE = "GSPUR2";
END;
/*TODO LO QUE CRUZA CON EL GD MENOS SUSTAINAIY LINKED, QUE SE CLASIFICA COMO GENERAL PURPOSE*/
	/*REVISAR: SOLO APLICA A NFC Y LG*/
IF FLAG_SFCS = 1 THEN DO;
	GS_PURPOSE = "Specific Purpose"; GS_PURPOSE_CODE = "GSPUR2";
		IF LEVEL1 IN ("SUSTAINABILITY LINKED","VINCULADO A SOSTENIBILIDAD") OR LEVEL2 IN ("SUSTAINABILITY LINKED","VINCULADO A SOSTENIBILIDAD")  THEN DO;
			GS_PURPOSE  = "General Purpose";GS_PURPOSE_CODE = "GSPUR1";
		END;
END; 
/* SPECIALISED LENDING *********************************************************************************************************/
IF F_LENDING = 1 THEN DO;
	GS_PURPOSE = "Specific Purpose"; GS_PURPOSE_CODE = "GSPUR2";
END;
* TANGIBLE ASSETS *************************************************************************************************************;
IF MAIN_CATEGORY = 'REAL ESTATE' THEN DO;
	GS_PURPOSE = "Specific Purpose"; GS_PURPOSE_CODE = "GSPUR2";
END;
/*N/A*/
* CENTRAL BANKS*************************************************************************************************************;
IF SECTOR = "CENTRAL BANKS" THEN DO;
	GS_PURPOSE = "N/A"; GS_PURPOSE_CODE = "N/A"; 
END;
*SOVEREIGNS - GENERAL*************************************************************************************************************;
IF SECTOR = "GENERAL GOVERNMENTS" THEN DO;
	IF ESG_SUBSECTOR = "SOVEREIGNS" THEN DO;
		 GS_PURPOSE = "General Purpose";GS_PURPOSE_CODE = "GSPUR1";
	END;
END;
/*MAIN CATEGORY N/A*/
IF MAIN_CATEGORY IN ('GOODWILL',
'OTHER INTANGIBLE ASSETS',
'BRAND NAMES',
'CREDIT CARDS',
'CUSTOMER LISTS',
'IT DEVELOPMENTS',
'STABLE FUNDING WITH LOW REMUNERATION',
'ACCRUAL - OTHER ASSETS',
'INSURANCE CONTRACTS LINKED TO PENSIONS',
'INVENTORY',
'NET ASSETS IN PENSION PLANS',
'PROVISIONS FOR SECURITISATION FUNDS',
'REST OTHER ASSETS',
'TRANSACTIONS IN TRANSIT - OTHER ASSETS',
'NON-FINANCIAL GUARANTEES GIVEN',
'OTHER COMMITMENTS GIVEN, REST',
'COMPUTER HARDWARE AND RELATED FACILITIES',
'CONSTRUCTION IN PROGRESS',
'FURNITURE, FIXTURES AND VEHICLES',
'OTHER TANGIBLE ASSETS',
'CASH ON HAND',
'CREDIT INVESTMENT IN SECURITIZATION VEHICLES',
'DERIVATIVES',
'FAIR VALUE CHANGES OF THE HEDGED ITEMS IN PORTFOLIO HEDGE OF INTEREST RATE RISK - ASSET',
'INSURANCE AND REINSURANCE CONTRACTS - ASSETS',
'INTANGIBLE ASSETS',
'LOAN COMMITMENTS GIVEN',
'OTHER ASSETS',
'OTHER COMMITMENTS GIVEN',
'TAX ASSETS',
'CURRENT TAX ASSETS',
'DEFERRED TAX ASSETS') THEN DO; GS_PURPOSE = "N/A"; GS_PURPOSE_CODE = "N/A";
END;

IF MAIN_CATEGORY = 'REAL ESTATE' AND ASSETS_ORIGIN NE 'FORECLOSED/DATION IN PAYMENT' THEN DO;
	GS_PURPOSE = "N/A"; GS_PURPOSE_CODE = "N/A";
END;

IF SECTOR = "N/A" AND MAIN_CATEGORY NE 'REAL ESTATE' THEN DO;
	GS_PURPOSE = "N/A"; GS_PURPOSE_CODE = "N/A";
END;

IF MAIN_CATEGORY = 'LOANS AND ADVANCES' AND ACCOUNTING_PORTFOLIO = 'CASH AND CASH BALANCES AT CENTRAL BANKS AND OTHER DEMAND DEPOSITS' THEN DO;
	GS_PURPOSE = "N/A"; GS_PURPOSE_CODE = "N/A";
END;

IF SECTOR = "HOUSEHOLDS" AND PURPOSE_ESG = "N/A" THEN DO; 
			 GS_PURPOSE = "General Purpose";GS_PURPOSE_CODE = "GSPUR1";
END;
/*PURPOSE ESG - SOLO APLICA A SPECIFIC PURPOSE*/
IF GS_PURPOSE IN ("General Purpose", "N/A") THEN DO;
	PURPOSE_ESG = "N/A";
    PURPOSE_ESG_CODE = "N/A";
END;
RUN;

**ELIGIBLE***********************************************************************************************************************************;
DATA ELIG_TABLA;
SET G_S_TABLA;

FORMAT     SP_ELIG $50. ;
FORMAT     SP_ELIG_CODE $50. ;

/* SPECIALISED LENDING - PROJECT FINANCE- ELEGIBLE SI NO CUMPLE CON ALGUNA DE LAS ACTIVIDADES A CONTINUACIÓN*********************************************************************************************************/
IF F_LENDING = 1 THEN DO;
	SP_ELIG = "Climate Change Mitigation"; SP_ELIG_CODE = "SELI1";
END;
/****NO ELEGIBLE - POR ESTAR INCLUIDO EN SFICS Y NO EU TAXO*/
IF ACTIVIDAD_SFCS IN ('A.1.32 - RENEWABLE ENERGY PROCUREMENT',
'A.2.21 - HYDROGEN POWERED-VEHICLES',
'A.6.2 - SUSTAINABLE WATER MANAGEMENT',
'A.6.26  USE OF RECYCLED MATERIALS',
'A.7.7 - SUSTAINABLE GROWING OF CROPS',
'A.7.8 - SOIL REMEDIATION',
'A.7.9 - LOW-CARBON AGRICULTURAL TECHNOLOGIES TO IMPROVE EFFICIENCY (E.G. TECHNIQUES USED IN PRECISION FARMING, HYDROPONICS FARMING, AEROPONICS FARMING)',
'A.7.10 - EFFICIENT ELECTRIC MACHINERY, EXCLUDING TECH FOR LIVESTOCK PRODUCTION',
'A.7.11 - REGENERATIVE FARMING',
'A.7.12 - AGRICULTURAL STRUCTURES',
'A.7.13 - INTEGRATED CROP-LIVESTOCK-FORESTRY SYSTEMS (ICLFS)',
'A.7.14 - SUSTAINABLE FEED PRODUCTION',
'A.7.15 - LIVESTOCK MANAGEMENT',
'A.7.16 - SUSTAINABLE AQUACULTURE AND FISHING',
'A.7.17 - CARBON SEQUESTRATION ACTIVITIES',
'A.7.18 - SUSTAINABLE AGRICULTURAL PRODUCTION',
'A.7.19 - ORGANIC FARMING',
'A.7.20 - SUSTAINABLE LAND PURCHASE AND TRANSFORMATION',
'A.8.26  MANUFACTURE OF CLEAN NAPHTHA',
'A.8.27 - MANUFACTURE AND INSTALLATION OF EQUIPMENT EFFICIENT IN TERMS OF ENERGY CONSUMPTION',
'A.11.1 - CARBON MARKET',
'RENEWABLE ENERGY PROCUREMENT',
'HYDROGEN POWERED-VEHICLES',
'SUSTAINABLE WATER MANAGEMENT',
'USE OF RECYCLED MATERIALS',
'SUSTAINABLE GROWING OF CROPS',
'SOIL REMEDIATION',
'LOW-CARBON AGRICULTURAL TECHNOLOGIES TO IMPROVE EFFICIENCY (E.G. TECHNIQUES USED IN PRECISION FARMING, HYDROPONICS FARMING, AEROPONICS FARMING)',
'EFFICIENT ELECTRIC MACHINERY, EXCLUDING TECH FOR LIVESTOCK PRODUCTION',
'REGENERATIVE FARMING',
'AGRICULTURAL STRUCTURES',
'INTEGRATED CROP-LIVESTOCK-FORESTRY SYSTEMS (ICLFS)',
'SUSTAINABLE FEED PRODUCTION',
'LIVESTOCK MANAGEMENT',
'SUSTAINABLE AQUACULTURE AND FISHING',
'CARBON SEQUESTRATION ACTIVITIES',
'SUSTAINABLE AGRICULTURAL PRODUCTION',
'ORGANIC FARMING',
'SUSTAINABLE LAND PURCHASE AND TRANSFORMATION',
'MANUFACTURE OF CLEAN NAPHTHA',
'MANUFACTURE AND INSTALLATION OF EQUIPMENT EFFICIENT IN TERMS OF ENERGY CONSUMPTION',
'CARBON MARKET') THEN DO; 	
	SP_ELIG = "No"; SP_ELIG_CODE = "SELI3";
END;

IF SECTOR IN ("HOUSEHOLDS","NON FINANCIAL CORPORATION", "OTHER FINANCIAL CORPORATION", "CREDIT INSTITUTIONS","GENERAL GOVERNMENTS") AND GS_PURPOSE="Specific Purpose" THEN DO;
	/*MOTOR VEHICLE LOANS*/
	IF PURPOSE_ESG = "MOTOR VEHICLE LOANS" THEN DO;
		SP_ELIG = "Climate Change Mitigation"; SP_ELIG_CODE = "SELI1";
	END;
	/*BUILDING ACQUISITION**********************************************************************************/
	IF PURPOSE_ESG = "BUILDING ACQUISITION LOANS" THEN DO;
		SP_ELIG = "Climate Change Mitigation"; SP_ELIG_CODE = "SELI1";
		/*NO ELEGIBLE - BUILDING ACQUISITION QUE NO OPTAN A RECIBIR EPC*/
		IF Clasificacion_final IN ("6. No cumple uso", "7. No aplica") THEN DO;
			SP_ELIG = "No"; SP_ELIG_CODE = "SELI3";
		END;
	END;
END;
	/*BUILDING RENOVATION*********************************************************************************/
IF SECTOR IN ("HOUSEHOLDS","NON FINANCIAL CORPORATION") AND PURPOSE_ESG = "BUILDING RENOVATION LOANS" THEN DO;
	SP_ELIG = "Climate Change Mitigation"; SP_ELIG_CODE = "SELI1";
END;
/* ACTIVIDADES AGRO Y OTHER COMO NO ELIGIBLE
INCLUIDO - NUEVA ACTIVIDAD GD ESPAÑA - DIC24*/
IF FLAG_SFCS = 1 THEN DO;
	IF LEVEL1 IN ("AGRICULTURE, FORESTRY AND LIVESTOCK", "AGRO", "OTHER ACTIVITIES RELEVANT FOR CLIMATE CHANGE MITIGATION ADAPTATION", "OTHER ACTIVITIES FOR CLIMATE CHANGE MITIGATION/ADAPTATION", "OTHER ACTIVITIES RELEVANT FOR CLIMATE CHANGE MITIGATION A","OTHER ACTIVITIES RELEVANT FOR CLIMATE CHANGE MITIGATION/A","OTRAS ACTIVIDADES RELEVANTES PARA LA MITIGACION O ADAPTACION DEL CAMBIO CLIMATICO","AGRICULTURA, SILVICULTURA Y GANADERÍA","AGRICULTURA, SILVICULTURA Y GANADERIA") OR LEVEL2 IN ('GROWING OF CROPS','GROWING OF CROPS',
				'SUSTAINABLE AGRICULTURE',
				'PROTECTED AGRICULTURE',
				'AFFORESTATION / REFORESTATION',
				'LAND CONSERVATION AND REFORESTATION & SOIL REMEDIATION',
				'ANIMAL HUSBANDRY',
				'SUSTAINABLE AQUACULTURE',
				'FOREST MANAGEMENT',
				'LAND CONSERVATION AND RESTORATION',
				'SUSTAINABLE AGRICULTURE, ANIMAL HUSBANDRY AND FISHERY',"OTRAS ACTIVIDADES RELEVANTES PARA LA MITIGACIÓN O ADAPTACIÓN DEL CAMBIO CLIMÁTICO","OTRAS ACTIVIDADES RELEVANTES PARA LA MITIGACION O ADAPTACION DEL CAMBIO CLIMATICO","AGRICULTURA, SILVICULTURA Y GANADERÍA","AGRICULTURA, SILVICULTURA Y GANADERIA") THEN DO;
		SP_ELIG = "No"; SP_ELIG_CODE = "SELI3";
	END;
	ELSE DO; SP_ELIG = "Climate Change Mitigation"; SP_ELIG_CODE = "SELI1";
	END;
END;
/* TANGIBLE ASSETS: COLLATERALS OBTAINED BY TAKING POSSESSION*************************************************************************************************************/
IF MAIN_CATEGORY = 'REAL ESTATE' AND GS_PURPOSE = "Specific Purpose" THEN DO; 
	SP_ELIG = "No"; SP_ELIG_CODE = "SELI3";
END;
/*ACTIVIDADES RELACIONADAS CON AGRICULTURA*/
IF GS_PURPOSE NOT IN ("General Purpose", "N/A") AND LEVEL1 IN ("AGRICULTURE, FORESTRY AND LIVESTOCK", "AGRO", "OTHER ACTIVITIES RELEVANT FOR CLIMATE CHANGE MITIGATION ADAPTATION", "OTHER ACTIVITIES FOR CLIMATE CHANGE MITIGATION/ADAPTATION", "OTHER ACTIVITIES RELEVANT FOR CLIMATE CHANGE MITIGATION A","OTHER ACTIVITIES RELEVANT FOR CLIMATE CHANGE MITIGATION/A","OTRAS ACTIVIDADES RELEVANTES PARA LA MITIGACION O ADAPTACION DEL CAMBIO CLIMATICO","AGRICULTURA, SILVICULTURA Y GANADERÍA","AGRICULTURA, SILVICULTURA Y GANADERIA") OR LEVEL2 IN ('GROWING OF CROPS','GROWING OF CROPS',
				'SUSTAINABLE AGRICULTURE',
				'PROTECTED AGRICULTURE',
				'AFFORESTATION / REFORESTATION',
				'LAND CONSERVATION AND REFORESTATION & SOIL REMEDIATION',
				'ANIMAL HUSBANDRY',
				'SUSTAINABLE AQUACULTURE',
				'FOREST MANAGEMENT',
				'LAND CONSERVATION AND RESTORATION',
				'SUSTAINABLE AGRICULTURE, ANIMAL HUSBANDRY AND FISHERY',"OTRAS ACTIVIDADES RELEVANTES PARA LA MITIGACIÓN O ADAPTACIÓN DEL CAMBIO CLIMÁTICO","OTRAS ACTIVIDADES RELEVANTES PARA LA MITIGACION O ADAPTACION DEL CAMBIO CLIMATICO","AGRICULTURA, SILVICULTURA Y GANADERÍA","AGRICULTURA, SILVICULTURA Y GANADERIA") THEN DO;
		SP_ELIG = "No"; SP_ELIG_CODE = "SELI3";
END;
/*CONDICION FINAL: SI ES GENERAL PURPOSE O N/A ES N/A ELEGIBLE*/
IF GS_PURPOSE IN ("General Purpose", "N/A") THEN DO;
	SP_ELIG = "N/A"; SP_ELIG_CODE = "N/A";
END;
RUN;

**SUSTAINABILITY****************************************************************;
DATA SUST_TABLA_HH_1;
SET ELIG_TABLA;
format     SP_SUST $50. ;
format     SP_SUST_CODE $50. ;

/*HOUSEHOLDS*/
IF SECTOR="HOUSEHOLDS" AND SP_ELIG = "Climate Change Mitigation" THEN DO;
	SP_SUST='No'; SP_SUST_CODE='SSUS4';
	*Building Acquisition;
	IF COLLATERAL = 'REAL ESTATE. RESIDENTIAL' THEN DO;
		IF CHRONIC_CODE NE 'CHRO1' AND ACUTE_CODE NE 'ACUT1' THEN DO;
			*Built before 2020;
			*Letras A B y C*;
			IF anoedifi<=2020 AND EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA = 'Real' THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			IF anoedifi = . AND EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA ='Real' THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			*Letra D*;
			IF anoedifi<=2020 AND EPC_LABEL = "D" AND EPC_LABEL_DATA='Real' AND 
			PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI", "BARCELON", "GIRONA",
			"LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES") THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			IF anoedifi = . AND EPC_LABEL = "D" AND EPC_LABEL_DATA='Real' AND 
			PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI", "BARCELON", "GIRONA",
			"LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES") THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;

			*Built after 2020;
			IF anoedifi>2020 AND COLLATERAL = "REAL ESTATE. RESIDENTIAL" THEN DO;
				*Letras A B y C*;
				IF EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA='Real' THEN DO;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=18 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=25.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=28.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=34.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=38.7 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF PROVINCIA IN ("CEUTA","MELILLA", "ILLES BA","LAS PALM","S.C. TEN") THEN DO;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=28.1 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=31.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=36.0 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=42.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=48.4 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
					END;
				END;
				*Letra D*;
				IF EPC_LABEL = "D" AND EPC_LABEL_DATA='Real' AND PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI",
				"BARCELON", "GIRONA","LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES")THEN DO;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=18 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=25.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=28.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=34.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=38.7 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF PROVINCIA IN ("CEUTA","MELILLA", "ILLES BA","LAS PALM","S.C. TEN") THEN DO;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=28.1 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=31.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=36.0 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=42.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=48.4 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
					END;
				END;
			END;
		END;
	END;
END;
/*N/A o No*/
IF SP_ELIG ="N/A" THEN DO;
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;
IF GS_PURPOSE IN ("N/A","General Purpose") THEN DO;
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;
IF SP_ELIG = "Climate Change Mitigation" AND SP_SUST = "N/A" THEN DO;
	SP_SUST = "No"; SP_SUST_CODE = "SSUS4";
END;	
RUN;
/*NON FINANCIAL CORPORATION - NO SUJETAS NFRD PARA BTAR*/
DATA SUST_TABLA_NFC;
SET SUST_TABLA_HH_1;
format     SP_SUST $50. ;
format     SP_SUST_CODE $50. ;

/*N/A o No*/
IF SP_ELIG = "N/A" THEN DO;
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;
IF GS_PURPOSE IN ("N/A","General Purpose") THEN DO;
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;
IF SECTOR NOT IN ("NON FINANCIAL CORPORATION","HOUSEHOLDS") AND SP_ELIG = "Climate Change Mitigation" THEN DO;
	SP_SUST='No'; SP_SUST_CODE='SSUS4';
END;
/* POR DEFECTO - PURE - CRUZO CON GREENDASHBOARD*/
IF SECTOR = "NON FINANCIAL CORPORATION" AND FLAG_NFRD_GAR=0 AND SP_ELIG = "Climate Change Mitigation" AND FLAG_SFCS = 1 THEN DO; 
	SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";

	/*ACTIVIDADES ALINEADAS PURE - POR HABER SIDO APROBADAS POR EL SFICS CON EL FLAG EU CONSISTENT*/
	IF ACTIVIDAD_SFCS IN (
	'2. A.3.3 INSTALLATION, MAINTENANCE AND REPAIR OF ENERGY EFFICIENCY EQUIPMENT',
	'3. A.3.4 INSTALLATION, MAINTENANCE AND REPAIR OF CHARGING STATIONS FOR ELECTRIC VEHICLES IN BUILDINGS (AND PARKING SPACES ATTACHED TO BUILDINGS)',
	'4. A.3.5 INSTALLATION, MAINTENANCE AND REPAIR OF INSTRUMENTS AND DEVICES FOR MEASURING, REGULATION AND CONTROLLING ENERGY PERFORMANCE OF BUILDINGS',
	'5. A.3.6 INSTALLATION, MAINTENANCE AND REPAIR OF RENEWABLE ENERGY TECHNOLOGIES',
	'A.3.3 INSTALLATION, MAINTENANCE AND REPAIR OF ENERGY EFFICIENCY EQUIPMENT',
	'A.3.4 INSTALLATION, MAINTENANCE AND REPAIR OF CHARGING STATIONS FOR ELECTRIC VEHICLES IN BUILDINGS (AND PARKING SPACES ATTACHED TO BUILDINGS)',
	'A.3.5 INSTALLATION, MAINTENANCE AND REPAIR OF INSTRUMENTS AND DEVICES FOR MEASURING, REGULATION AND CONTROLLING ENERGY PERFORMANCE OF BUILDINGS',
	'A.3.6 INSTALLATION, MAINTENANCE AND REPAIR OF RENEWABLE ENERGY TECHNOLOGIES',
	'INSTALLATION, MAINTENANCE AND REPAIR OF ENERGY EFFICIENCY EQUIPMENT',
	'INSTALLATION, MAINTENANCE AND REPAIR OF CHARGING STATIONS FOR ELECTRIC VEHICLES IN BUILDINGS (AND PARKING SPACES ATTACHED TO BUILDINGS)',
	'INSTALLATION, MAINTENANCE AND REPAIR OF INSTRUMENTS AND DEVICES FOR MEASURING, REGULATION AND CONTROLLING ENERGY PERFORMANCE OF BUILDINGS',
	'INSTALLATION, MAINTENANCE AND REPAIR OF RENEWABLE ENERGY TECHNOLOGIES') THEN DO;
		SP_SUST = "Enabling"; SP_SUST_CODE = "SSUS2";
	END;	

	/*ACTIVIDADES ALINEADAS TRANSITIONAL - POR HABER SIDO APROBADAS POR EL SFICS CON EL FLAG EU CONSISTENT*/
	IF ACTIVIDAD_SFCS IN ('A.3.2 RENOVATION OF EXISTING BUILDINGS',
	'RENOVATION OF EXISTING BUILDINGS') THEN DO;
		SP_SUST = "Transitional"; SP_SUST_CODE = "SSUS1";
	END;
	
	/*BULDING ACQUISITIONS*/
	IF COLLATERAL IN ('REAL ESTATE. RESIDENTIAL','REAL ESTATE. COMMERCIAL') AND FLAG_NFRD_GAR=0 THEN DO;
			*Built before 2020;
			*Letras A B y C*;
			IF anoedifi<=2020 AND EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA IN ('Real','Estimated') THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			IF anoedifi = . AND EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA IN ('Real','Estimated') THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			*Letra D*;
			IF anoedifi<=2020 AND EPC_LABEL = "D" AND EPC_LABEL_DATA IN ('Real','Estimated') AND 
			PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI", "BARCELON", "GIRONA",
			"LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES") THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			IF anoedifi = . AND EPC_LABEL = "D" AND EPC_LABEL_DATA IN ('Real','Estimated') AND 
			PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI", "BARCELON", "GIRONA",
			"LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES") THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;

			*Built after 2020;
			IF anoedifi>2020 AND COLLATERAL IN ("REAL ESTATE. RESIDENTIAL", "REAL ESTATE. COMMERCIAL") AND FLAG_NFRD_GAR=0 THEN DO;
				*Letras A B y C*;
				IF EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA IN ('Real','Estimated') THEN DO;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=18 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=25.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=28.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=34.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=38.7 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF PROVINCIA IN ("CEUTA","MELILLA", "ILLES BA","LAS PALM","S.C. TEN") THEN DO;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=28.1 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=31.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=36.0 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=42.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=48.4 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
					END;
				END;
				*Letra D*;
				IF EPC_LABEL = "D" AND EPC_LABEL_DATA IN ('Real','Estimated') AND PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI",
				"BARCELON", "GIRONA","LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES")THEN DO;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=18 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=25.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=28.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=34.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=38.7 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF PROVINCIA IN ("CEUTA","MELILLA", "ILLES BA","LAS PALM","S.C. TEN") THEN DO;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=28.1 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=31.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=36.0 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=42.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=48.4 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
					END;
				END;
			END;
		END;

	/*BUILDING RENOVATION > NFC NO SUJETAS A NFRD*********************************************************************************/
	IF PURPOSE_ESG = "BUILDING RENOVATION LOANS"  THEN DO;
		SP_SUST = "Enabling"; SP_SUST_CODE = "SSUS2";
	END;
	/*INCLUIDO NOV24*/
	IF LEVEL1 IN ('1.1 RENEWABLE ENERGY PRODUCTION'
			'1.3. TRANSMISSION AND DISTRIBUTION OF ELECTRICITY','RENEWABLE ENERGY PRODUCTION'
			'TRANSMISSION AND DISTRIBUTION OF ELECTRICITY','1.1 RENEWABLE ENERGY GENERATION','RENEWABLE ENERGY GENERATION','Distribution and transmission of electricity, gas and heat/cool',
			'DISTRIBUTION AND TRANSMISSION OF ELECTRICITY, GAS AND HEAT/COOL') OR LEVEL2 IN ('1.1 RENEWABLE ENERGY PRODUCTION'
			'1.3. TRANSMISSION AND DISTRIBUTION OF ELECTRICITY','RENEWABLE ENERGY PRODUCTION'
			'TRANSMISSION AND DISTRIBUTION OF ELECTRICITY','1.1 RENEWABLE ENERGY GENERATION','RENEWABLE ENERGY GENERATION','Distribution and transmission of electricity, gas and heat/cool',
			'DISTRIBUTION AND TRANSMISSION OF ELECTRICITY, GAS AND HEAT/COOL') THEN DO;
		SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
	END;
	/*Infraestructuras, no coches*/
	IF LEVEL1 IN ('2.4 TRANSPORT INFRASTRUCTURE','TRANSPORT INFRASTRUCTURE','CIVIL ENGINEERING GROUND WATER AND UTILITY PROJECTS') OR LEVEL2 IN ('2.4 TRANSPORT INFRASTRUCTURE','TRANSPORT INFRASTRUCTURE','CIVIL ENGINEERING GROUND WATER AND UTILITY PROJECTS') THEN DO;
		SP_SUST= 'Enabling'; SP_SUST_CODE = "SSUS2";
	END;
	IF FLAG_BONOS_BTAR NE "" THEN DO;
		SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
	END;

		/*CRUZO CON GREENDASHBOARD - ALINEADO*/
	IF TIPO_ACTIVIDAD_EU_TAXO = "Transitional" THEN DO;
			SP_SUST= 'Transitional'; SP_SUST_CODE = "SSUS1";
	END;
	IF TIPO_ACTIVIDAD_EU_TAXO = "Enabling" THEN DO;
			SP_SUST= 'Enabling'; SP_SUST_CODE = "SSUS2";
	END;
END;

/* ALINEAMIENTO PARA LO QUE NO CRUCE CON GREENDASHBOARD*/
IF SECTOR = "NON FINANCIAL CORPORATION"  AND SP_ELIG = "Climate Change Mitigation" AND FLAG_SFCS = 0 THEN DO; 
	SP_SUST='No'; SP_SUST_CODE='SSUS4';
	*Building Acquisition;
	IF COLLATERAL IN ('REAL ESTATE. RESIDENTIAL','REAL ESTATE. COMMERCIAL') AND FLAG_NFRD_GAR=0 THEN DO;
			*Built before 2020;
			*Letras A B y C*;
			IF anoedifi<=2020 AND EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA IN ('Real','Estimated') THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			IF anoedifi = . AND EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA IN ('Real','Estimated') THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			*Letra D*;
			IF anoedifi<=2020 AND EPC_LABEL = "D" AND EPC_LABEL_DATA IN ('Real','Estimated') AND 
			PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI", "BARCELON", "GIRONA",
			"LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES") THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;
			IF anoedifi = . AND EPC_LABEL = "D" AND EPC_LABEL_DATA IN ('Real','Estimated') AND 
			PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI", "BARCELON", "GIRONA",
			"LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES") THEN DO;
				SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
			END;

			*Built after 2020;
			IF anoedifi>2020 AND COLLATERAL IN ("REAL ESTATE. RESIDENTIAL", "REAL ESTATE. COMMERCIAL") AND FLAG_NFRD_GAR=0 THEN DO;
				*Letras A B y C*;
				IF EPC_LABEL IN ("A","B","C") AND EPC_LABEL_DATA IN ('Real','Estimated') THEN DO;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=18 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=25.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=28.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=34.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=38.7 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF PROVINCIA IN ("CEUTA","MELILLA", "ILLES BA","LAS PALM","S.C. TEN") THEN DO;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=28.1 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=31.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=36.0 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=42.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=48.4 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
					END;
				END;
				*Letra D*;
				IF EPC_LABEL = "D" AND EPC_LABEL_DATA IN ('Real','Estimated') AND PROVINCIA IN ("ASTURIAS", "S.C. TEN", "LAS PALM", "CANTABRI",
				"BARCELON", "GIRONA","LLEIDA", "TARRAGON", "BADAJOZ", "MURCIA", "ALICANTE", "CASTELLÃ", "VALENCIA", "CÃCERES","CÃ CERES")THEN DO;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=18 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=25.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=28.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=34.2 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=38.7 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
					END;
					IF PROVINCIA IN ("CEUTA","MELILLA", "ILLES BA","LAS PALM","S.C. TEN") THEN DO;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'Î' AND THRESHOLD<=22.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'A' AND THRESHOLD<=28.1 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'B' AND THRESHOLD<=31.5 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'C' AND THRESHOLD<=36.0 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'D' AND THRESHOLD<=42.8 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
						IF SUBSTR(ZONA_CLIMATICA_NUMBIEN,1,1)= 'E' AND THRESHOLD<=48.4 THEN DO;
						SP_SUST= 'Pure'; SP_SUST_CODE = "SSUS3";
						END;
					END;
				END;
			END;
		END;
	END;

/*************AJUSTES POR ERRORES****************************************************************************************************************************************************************************/
IF SECTOR = "N/A" OR COLLATERAL = "N/A" THEN DO;
	SP_SUST= 'N/A'; SP_SUST_CODE = "N/A";
END;

/*N/A o No*/
IF SP_ELIG IN ("N/A", "No") THEN DO;
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;
IF GS_PURPOSE IN ("N/A","General Purpose") THEN DO;
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;

IF SECTOR = "NON FINANCIAL CORPORATION" AND FLAG_NFRD_GAR = 1 AND SP_ELIG = 'Climate Change Mitigation' THEN DO;
	SP_SUST = "No"; SP_SUST_CODE = "SSUS4";
END;
IF SECTOR IN ("OTHER FINANCIAL CORPORATION","CREDIT INSTITUTIONS","GENERAL GOVERNMENTS","CENTRAL BANKS") AND SP_ELIG = 'Climate Change Mitigation' THEN DO;
	SP_SUST = "No"; SP_SUST_CODE = "SSUS4";
END;
IF SP_ELIG = "Climate Change Mitigation" AND SP_SUST = "N/A" THEN DO;
	SP_SUST = "No"; SP_SUST_CODE = "SSUS4";
END;
/*NO HOUSEHOLDS, NFC*/
IF SECTOR NOT IN ("HOUSEHOLDS","NON FINANCIAL CORPORATION") AND SP_ELIG = 'Climate Change Mitigation' THEN DO;
	SP_SUST = "No"; SP_SUST_CODE = "SSUS4";
END;

/* THIS VARIABLE SHOULD ONLY BE MARKED AS YES IF THE SPECIALIZED LENDING IS ALIGNED WITH THE EU TAXO. TO IDENTIFY IF IT IS ALIGNED, 
	TO SFCS PANEL OR SFICS SHOULD BE USED FOLLOWING THE CRITERIA ESTABLISHED ABOVE.*/
IF F_LENDING = 1 AND SP_SUST = "No" THEN DO; F_LENDING = 0;END;

/*PURPOSE ESG - N/A*/
/*No aplica a collateral obtained by taking possession*/
IF MAIN_CATEGORY='REAL ESTATE' THEN DO;
	PURPOSE_ESG = "N/A";
    PURPOSE_ESG_CODE = "N/A";
END;
/*SOLO APLICA A HOUSEHOLDS, NFC y LOCAL GOV.*/
IF SECTOR IN ('OTHER FINANCIAL CORPORATION','CREDIT INSTITUTIONS') OR (SECTOR='GENERAL GOVERNMENTS' AND ESG_SUBSECTOR NE 'LOCAL GOVERNMENTS') THEN DO;
	PURPOSE_ESG = "N/A";
    PURPOSE_ESG_CODE = "N/A";
END;
/*Other Purpose para Households*/
IF SECTOR = "HOUSEHOLDS" AND PURPOSE_ESG = "OTHER PURPOSE" THEN DO;
	PURPOSE_ESG = "N/A";PURPOSE_ESG_CODE = "N/A";
END;
IF MAIN_CATEGORY= "REAL ESTATE" THEN DO;
	PURPOSE_ESG = "N/A";PURPOSE_ESG_CODE = "N/A";
END;
/*N/A o No*/
IF SP_ELIG IN ("N/A", "No") THEN DO;
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;
IF GS_PURPOSE IN ("N/A","General Purpose") THEN DO;
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;


RUN;


**NFRD**************************************************************************************;
DATA NFRD_TABLA;
SET SUST_TABLA_NFC;

FORMAT     NFRD $50. ;
FORMAT     NFRD_CODE $50. ;

IF SECTOR  IN ('OTHER FINANCIAL CORPORATION', 'CREDIT INSTITUTIONS', 'NON FINANCIAL CORPORATION') THEN DO;
     IF FLAG_NFRD_GAR = 1 THEN DO;
          NFRD_CODE = "NFRD1"; 
          NFRD = "SUBJECT TO NFRD";
     END; 
      ELSE DO;
         NFRD_CODE = "NFRD2"; 
          NFRD = "NOT SUBJECT TO NFRD";
     END;
END;
ELSE DO;
     NFRD_CODE = "N/A";
     NFRD = "N/A";
END;
RUN;

**EU****************************************************************************************;
DATA EU_TABLA;
SET NFRD_TABLA;

FORMAT     EU $50. ;
FORMAT     EU_CODE $50. ;

IF SECTOR  IN ('NON FINANCIAL CORPORATION', 'OTHER FINANCIAL CORPORATION', 'CREDIT INSTITUTIONS') THEN DO;
	IF NFRD = "NOT SUBJECT TO NFRD" THEN DO;
	    IF PAISRE_TIT IN ('AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE') THEN DO 
	          EU = "EU AREA"; 
	          EU_CODE = "EU1"; 
	     END;
	     ELSE DO
	          EU = "NON EU AREA"; 
	          EU_CODE = "EU2"; 
	     END;
	END;
	ELSE DO;
	     EU = "";
	     EU_CODE = "";
	END;
END;
RUN;

**SPECIALISED LENDING*************************************************************************;
DATA SP_LEN_TABLA;
SET EU_TABLA;
FORMAT     SP_LENDING $3. ;
FORMAT     SP_LENDING_CODE $5. ;
/*Aplica a todos los sectores*/
IF SECTOR NE "NON FINANCIAL CORPORATION" THEN DO;
	SP_LENDING = "N/A";
	SP_LENDING_CODE = "N/A";
END;
IF SECTOR = "NON FINANCIAL CORPORATION" THEN DO;
	SP_LENDING = "N/A";
	SP_LENDING_CODE = 'N/A';
	IF MAIN_CATEGORY IN ('DEBT SECURITIES ACQUIRED','EQUITY INSTRUMENTS','FINANCIAL GUARANTEES GIVEN','INVESTMENTS IN SUBSIDIARIES, JOINT VENTURES AND ASSOCIATES','LOANS AND ADVANCES') AND GS_PURPOSE = "Specific Purpose" AND SP_ELIG = "Climate Change Mitigation" AND SP_SUST NOT IN ('No','N/A') AND NFRD = "NOT SUBJECT TO NFRD" THEN DO;
		IF F_LENDING = 1 THEN DO ; 
		  	SP_LENDING = "Yes";
		    SP_LENDING_CODE = 'SPLE1';
		END;
		ELSE IF F_LENDING = 0 THEN DO;
			SP_LENDING = "No";
			SP_LENDING_CODE = 'SPLE2';
		END;
	END;

END;

DATA AJUSTES_ERRORES;
SET SP_LEN_TABLA;
/*Añadido por errores*/
IF PURPOSE_ESG = "BUILDING ACQUISITION LOANS" THEN DO;
	SP_LENDING = "N/A";
	SP_LENDING_CODE = "N/A";
END;
/*La herramienta solo acepta SP LENDING (YES/NO) + CCM + SSUS1/SSUS2*/
/*Segun lo trasladado por P3 Corpo, eliminamos el flag de SP LENDING para evitar errores en la herramienta*/
IF SP_LENDING NE "N/A" AND SP_SUST_CODE NOT IN ("SSUS1","SSUS2") THEN DO;
	SP_LENDING = "N/A";
	SP_LENDING_CODE = "N/A";
END;
/*NFC + NO NFRD + NO COLATERAL REAL/OTHER COLATERAL + SP LENDING N/A -> NO ACEPTA SER VERDE*/
IF SECTOR ="NON FINANCIAL CORPORATION" AND NFRD = "NOT SUBJECT TO NFRD" AND SP_LENDING = "N/A" AND COLLATERAL NOT IN ('REAL ESTATE. RESIDENTIAL','REAL ESTATE. COMMERCIAL') AND SP_ELIG_CODE = "SELI1" AND SP_SUST_CODE IN ("SSUS1","SSUS2","SSUS3") THEN DO; 
	SP_SUST_CODE="SSUS4";
END;
/*HOUSEHOLDS + PURPOSE ESG N/A -> SOLO ACEPTA GENERAL PURPOSE*/
IF SECTOR = "HOUSEHOLDS" AND PURPOSE_ESG = "N/A" THEN DO;
	GS_PURPOSE = "General Purpose";	GS_PURPOSE_CODE = "GSPUR1";
	SP_ELIG = "N/A"; SP_ELIG_CODE = "N/A";
	SP_SUST = "N/A"; SP_SUST_CODE = "N/A";
END;
RUN;

**CRUCE RATIOS DE ELEGIBILIDAD****************************************************************;
*1º Cruzamos tabla granular con tabla externa de NFRD (CLARITY). Primary Key= LEI;
* Cruce TABLA con NFRD_GAR por LEI;
proc sort
data=SAVE.NFRD_GAR_JUN24 out=NFRD_GAR_LEI dupsout=duplicados nodupkey;
BY LEI;
QUIT;
DATA NFRD_GAR_LEI2;
SET NFRD_GAR_LEI;
WHERE LEI NE "";
RUN;
PROC SQL;
CREATE TABLE S84_10 AS
SELECT DISTINCT A.*,

TUCCA AS TUCCA_LEI,
ENTCCA AS ENTCCA_LEI,
ETCCA AS ETCCA_LEI,
CACCA AS CACCA_LEI,
ENCCCA AS ENCCCA_LEI,
ECCCA AS ECCCA_LEI,
TUCCM AS TUCCM_LEI,
ENTCCM AS ENTCCM_LEI,
TRANT AS TRANT_LEI,
ETCCM AS ETCCM_LEI,
CACCM AS CACCM_LEI,
ENCCCM AS ENCCCM_LEI,
TRANC AS TRANC_LEI,
ECCCM AS ECCCM_LEI,
TUPPC AS TUPPC_LEI,
ETPPC AS ETPPC_LEI,
CAPPC AS CAPPC_LEI,
ECPPC AS ECPPC_LEI,
TUBIO AS TUBIO_LEI,
ETBIO AS ETBIO_LEI,
CABIO AS CABIO_LEI,
ECBIO AS ECBIO_LEI,
TUWTR AS TUWTR_LEI,
ENTWTR AS ENTWTR_LEI,
ETWTR AS ETWTR_LEI,
CAWTR AS CAWTR_LEI,
ENCWTR AS ENCWTR_LEI,
ECWTR AS ECWTR_LEI,
TUCE AS TUCE_LEI,
ENTCE AS ENTCE_LEI,
ETCE AS ETCE_LEI,
CACE AS CACE_LEI,
ENCCE AS ENCCE_LEI,
ECCE AS ECCE_LEI
FROM AJUSTES_ERRORES A LEFT JOIN NFRD_GAR_LEI2 B
ON A.LEI= B.LEI;
QUIT;

*2º Cruzamos tabla granular con tabla externa de NFRD (CLARITY). Primary Key= GLCS5;
proc sort
data=SAVE.NFRD_GAR_JUN24 out=NFRD_GAR_GLCS5 dupsout=duplicados nodupkey;
BY GLCS_5;
QUIT;
DATA NFRD_GAR_GLCS5_2;
SET NFRD_GAR_GLCS5;
WHERE GLCS_5 NE "";
RUN;
PROC SQL;
CREATE TABLE S84_11 AS
SELECT DISTINCT A.*,
TUCCA AS TUCCA_KGL5,
ENTCCA AS ENTCCA_KGL5,
ETCCA AS ETCCA_KGL5,
CACCA AS CACCA_KGL5,
ENCCCA AS ENCCCA_KGL5,
ECCCA AS ECCCA_KGL5,
TUCCM AS TUCCM_KGL5,
ENTCCM AS ENTCCM_KGL5,
TRANT AS TRANT_KGL5,
ETCCM AS ETCCM_KGL5,
CACCM AS CACCM_KGL5,
ENCCCM AS ENCCCM_KGL5,
TRANC AS TRANC_KGL5,
ECCCM AS ECCCM_KGL5,
TUPPC AS TUPPC_KGL5,
ETPPC AS ETPPC_KGL5,
CAPPC AS CAPPC_KGL5,
ECPPC AS ECPPC_KGL5,
TUBIO AS TUBIO_KGL5,
ETBIO AS ETBIO_KGL5,
CABIO AS CABIO_KGL5,
ECBIO AS ECBIO_KGL5,
TUWTR AS TUWTR_KGL5,
ENTWTR AS ENTWTR_KGL5,
ETWTR AS ETWTR_KGL5,
CAWTR AS CAWTR_KGL5,
ENCWTR AS ENCWTR_KGL5,
ECWTR AS ECWTR_KGL5,
TUCE AS TUCE_KGL5,
ENTCE AS ENTCE_KGL5,
ETCE AS ETCE_KGL5,
CACE AS CACE_KGL5,
ENCCE AS ENCCE_KGL5,
ECCE AS ECCE_KGL5

FROM S84_10 A LEFT JOIN NFRD_GAR_GLCS5_2 B
ON A.KGL5 = B.GLCS_5;
QUIT;

data S84_12;
SET S84_11;
IF TUCCA_LEI NE '' THEN DO TUCCA_CODE=TUCCA_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  TUCCA_KGL5 NE '' THEN DO TUCCA_CODE=TUCCA_KGL5;CRUCE_GAR = 'KGL5';END;
IF ENTCCA_LEI NE '' THEN DO ENTCCA_CODE=ENTCCA_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ENTCCA_KGL5 NE '' THEN DO ENTCCA_CODE=ENTCCA_KGL5;CRUCE_GAR = 'KGL5';END;
IF ETCCA_LEI NE '' THEN DO ETCCA_CODE=ETCCA_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ETCCA_KGL5 NE '' THEN DO ETCCA_CODE=ETCCA_KGL5;CRUCE_GAR = 'KGL5';END;
IF CACCA_LEI NE '' THEN DO CACCA_CODE=CACCA_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  CACCA_KGL5 NE '' THEN DO CACCA_CODE=CACCA_KGL5;CRUCE_GAR = 'KGL5';END;
IF ENCCCA_LEI NE '' THEN DO ENCCCA_CODE=ENCCCA_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ENCCCA_KGL5 NE '' THEN DO ENCCCA_CODE=ENCCCA_KGL5;CRUCE_GAR = 'KGL5';END;
IF ECCCA_LEI NE '' THEN DO ECCCA_CODE=ECCCA_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ECCCA_KGL5 NE '' THEN DO ECCCA_CODE=ECCCA_KGL5;CRUCE_GAR = 'KGL5';END;
IF TUCCM_LEI NE '' THEN DO TUCCM_CODE=TUCCM_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  TUCCM_KGL5 NE '' THEN DO TUCCM_CODE=TUCCM_KGL5;CRUCE_GAR = 'KGL5';END;
IF ENTCCM_LEI NE '' THEN DO ENTCCM_CODE=ENTCCM_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ENTCCM_KGL5 NE '' THEN DO ENTCCM_CODE=ENTCCM_KGL5;CRUCE_GAR = 'KGL5';END;
IF TRANT_LEI NE '' THEN DO TRANT_CODE=TRANT_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  TRANT_KGL5 NE '' THEN DO TRANT_CODE=TRANT_KGL5;CRUCE_GAR = 'KGL5';END;
IF ETCCM_LEI NE '' THEN DO ETCCM_CODE=ETCCM_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ETCCM_KGL5 NE '' THEN DO ETCCM_CODE=ETCCM_KGL5;CRUCE_GAR = 'KGL5';END;
IF CACCM_LEI NE '' THEN DO CACCM_CODE=CACCM_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  CACCM_KGL5 NE '' THEN DO CACCM_CODE=CACCM_KGL5;CRUCE_GAR = 'KGL5';END;
IF ENCCCM_LEI NE '' THEN DO ENCCCM_CODE=ENCCCM_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ENCCCM_KGL5 NE '' THEN DO ENCCCM_CODE=ENCCCM_KGL5;CRUCE_GAR = 'KGL5';END;
IF TRANC_LEI NE '' THEN DO TRANC_CODE=TRANC_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  TRANC_KGL5 NE '' THEN DO TRANC_CODE=TRANC_KGL5;CRUCE_GAR = 'KGL5';END;
IF ECCCM_LEI NE '' THEN DO ECCCM_CODE=ECCCM_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ECCCM_KGL5 NE '' THEN DO ECCCM_CODE=ECCCM_KGL5;CRUCE_GAR = 'KGL5';END;
IF TUPPC_LEI NE '' THEN DO TUPPC_CODE=TUPPC_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  TUPPC_KGL5 NE '' THEN DO TUPPC_CODE=TUPPC_KGL5;CRUCE_GAR = 'KGL5';END;
IF ETPPC_LEI NE '' THEN DO ETPPC_CODE=ETPPC_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ETPPC_KGL5 NE '' THEN DO ETPPC_CODE=ETPPC_KGL5;CRUCE_GAR = 'KGL5';END;
IF CAPPC_LEI NE '' THEN DO CAPPC_CODE=CAPPC_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  CAPPC_KGL5 NE '' THEN DO CAPPC_CODE=CAPPC_KGL5;CRUCE_GAR = 'KGL5';END;
IF ECPPC_LEI NE '' THEN DO ECPPC_CODE=ECPPC_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ECPPC_KGL5 NE '' THEN DO ECPPC_CODE=ECPPC_KGL5;CRUCE_GAR = 'KGL5';END;
IF TUBIO_LEI NE '' THEN DO TUBIO_CODE=TUBIO_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  TUBIO_KGL5 NE '' THEN DO TUBIO_CODE=TUBIO_KGL5;CRUCE_GAR = 'KGL5';END;
IF ETBIO_LEI NE '' THEN DO ETBIO_CODE=ETBIO_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ETBIO_KGL5 NE '' THEN DO ETBIO_CODE=ETBIO_KGL5;CRUCE_GAR = 'KGL5';END;
IF CABIO_LEI NE '' THEN DO CABIO_CODE=CABIO_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  CABIO_KGL5 NE '' THEN DO CABIO_CODE=CABIO_KGL5;CRUCE_GAR = 'KGL5';END;
IF ECBIO_LEI NE '' THEN DO ECBIO_CODE=ECBIO_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ECBIO_KGL5 NE '' THEN DO ECBIO_CODE=ECBIO_KGL5;CRUCE_GAR = 'KGL5';END;
IF TUWTR_LEI NE '' THEN DO TUWTR_CODE=TUWTR_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  TUWTR_KGL5 NE '' THEN DO TUWTR_CODE=TUWTR_KGL5;CRUCE_GAR = 'KGL5';END;
IF ENTWTR_LEI NE '' THEN DO ENTWTR_CODE=ENTWTR_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ENTWTR_KGL5 NE '' THEN DO ENTWTR_CODE=ENTWTR_KGL5;CRUCE_GAR = 'KGL5';END;
IF ETWTR_LEI NE '' THEN DO ETWTR_CODE=ETWTR_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ETWTR_KGL5 NE '' THEN DO ETWTR_CODE=ETWTR_KGL5;CRUCE_GAR = 'KGL5';END;
IF CAWTR_LEI NE '' THEN DO CAWTR_CODE=CAWTR_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  CAWTR_KGL5 NE '' THEN DO CAWTR_CODE=CAWTR_KGL5;CRUCE_GAR = 'KGL5';END;
IF ENCWTR_LEI NE '' THEN DO ENCWTR_CODE=ENCWTR_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ENCWTR_KGL5 NE '' THEN DO ENCWTR_CODE=ENCWTR_KGL5;CRUCE_GAR = 'KGL5';END;
IF ECWTR_LEI NE '' THEN DO ECWTR_CODE=ECWTR_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ECWTR_KGL5 NE '' THEN DO ECWTR_CODE=ECWTR_KGL5;CRUCE_GAR = 'KGL5';END;
IF TUCE_LEI NE '' THEN DO TUCE_CODE=TUCE_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  TUCE_KGL5 NE '' THEN DO TUCE_CODE=TUCE_KGL5;CRUCE_GAR = 'KGL5';END;
IF ENTCE_LEI NE '' THEN DO ENTCE_CODE=ENTCE_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ENTCE_KGL5 NE '' THEN DO ENTCE_CODE=ENTCE_KGL5;CRUCE_GAR = 'KGL5';END;
IF ETCE_LEI NE '' THEN DO ETCE_CODE=ETCE_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ETCE_KGL5 NE '' THEN DO ETCE_CODE=ETCE_KGL5;CRUCE_GAR = 'KGL5';END;
IF CACE_LEI NE '' THEN DO CACE_CODE=CACE_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  CACE_KGL5 NE '' THEN DO CACE_CODE=CACE_KGL5;CRUCE_GAR = 'KGL5';END;
IF ENCCE_LEI NE '' THEN DO ENCCE_CODE=ENCCE_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ENCCE_KGL5 NE '' THEN DO ENCCE_CODE=ENCCE_KGL5;CRUCE_GAR = 'KGL5';END;
IF ECCE_LEI NE '' THEN DO ECCE_CODE=ECCE_LEI; CRUCE_GAR = 'LEI';END;ELSE IF  ECCE_KGL5 NE '' THEN DO ECCE_CODE=ECCE_KGL5;CRUCE_GAR = 'KGL5';END;
RUN;
*3º Establecemos todo igual a 0 para que en caso de quedar vacío, se deje valor 0;
DATA S84_13;
SET S84_12;
FORMAT     SP_LENDING $3. ;
FORMAT     SP_LENDING_CODE $5. ;
FORMAT TUCCA ENTCCA ETCCA CACCA ENCCCA ECCCA TUCCM ENTCCM TRANT ETCCM CACCM ENCCCM TRANC ECCCM TUPPC ETPPC CAPPC ECPPC TUBIO ETBIO CABIO ECBIO TUWTR ENTWTR ETWTR CAWTR ENCWTR ECWTR TUCE ENTCE ETCE CACE ENCCE ECCE 30.2;
FORMAT    GS_PURPOSE $50. ;
FORMAT    GS_PURPOSE_CODE $50. ;

IF GS_PURPOSE = "General Purpose" AND SECTOR IN("OTHER FINANCIAL CORPORATION", "NON FINANCIAL CORPORATION",
"CREDIT INSTITUTIONS","GENERAL GOVERNMENTS") THEN DO;
TUCCA = 0 ;
ENTCCA = 0 ;
ETCCA = 0 ;
CACCA = 0 ;
ENCCCA = 0 ;
ECCCA = 0 ;
TUCCM = 0 ;
ENTCCM = 0 ;
TRANT = 0 ;
ETCCM = 0 ;
CACCM = 0 ;
ENCCCM = 0 ;
TRANC = 0 ;
ECCCM = 0 ;
TUPPC = 0 ;
ETPPC = 0 ;
CAPPC = 0 ;
ECPPC = 0 ;
TUBIO = 0 ;
ETBIO = 0 ;
CABIO = 0 ;
ECBIO = 0 ;
TUWTR = 0 ;
ENTWTR = 0 ;
ETWTR = 0 ;
CAWTR = 0 ;
ENCWTR = 0 ;
ECWTR = 0 ;
TUCE = 0 ;
ENTCE = 0 ;
ETCE = 0 ;
CACE = 0 ;
ENCCE = 0 ;
ECCE = 0 ;

IF TUCCA_CODE NE . THEN DO;TUCCA = TUCCA_CODE* AMOUNT / 100; END; 
IF ENTCCA_CODE NE . THEN DO;ENTCCA = ENTCCA_CODE* AMOUNT / 100; END; 
IF ETCCA_CODE NE . THEN DO;ETCCA = ETCCA_CODE* AMOUNT / 100; END; 
IF CACCA_CODE NE . THEN DO;CACCA = CACCA_CODE* AMOUNT / 100; END; 
IF ENCCCA_CODE NE . THEN DO;ENCCCA = ENCCCA_CODE* AMOUNT / 100; END; 
IF ECCCA_CODE NE . THEN DO;ECCCA = ECCCA_CODE* AMOUNT / 100; END; 
IF TUCCM_CODE NE . THEN DO;TUCCM = TUCCM_CODE* AMOUNT / 100; END; 
IF ENTCCM_CODE NE . THEN DO;ENTCCM = ENTCCM_CODE* AMOUNT / 100; END; 
IF TRANT_CODE NE . THEN DO;TRANT = TRANT_CODE* AMOUNT / 100; END; 
IF ETCCM_CODE NE . THEN DO;ETCCM = ETCCM_CODE* AMOUNT / 100; END; 
IF CACCM_CODE NE . THEN DO;CACCM = CACCM_CODE* AMOUNT / 100; END; 
IF ENCCCM_CODE NE . THEN DO;ENCCCM = ENCCCM_CODE* AMOUNT / 100; END; 
IF TRANC_CODE NE . THEN DO;TRANC = TRANC_CODE* AMOUNT / 100; END; 
IF ECCCM_CODE NE . THEN DO;ECCCM = ECCCM_CODE* AMOUNT / 100; END; 
IF TUPPC_CODE NE . THEN DO;TUPPC = TUPPC_CODE* AMOUNT / 100; END; 
IF ETPPC_CODE NE . THEN DO;ETPPC = ETPPC_CODE* AMOUNT / 100; END; 
IF CAPPC_CODE NE . THEN DO;CAPPC = CAPPC_CODE* AMOUNT / 100; END; 
IF ECPPC_CODE NE . THEN DO;ECPPC = ECPPC_CODE* AMOUNT / 100; END; 
IF TUBIO_CODE NE . THEN DO;TUBIO = TUBIO_CODE* AMOUNT / 100; END; 
IF ETBIO_CODE NE . THEN DO;ETBIO = ETBIO_CODE* AMOUNT / 100; END; 
IF CABIO_CODE NE . THEN DO;CABIO = CABIO_CODE* AMOUNT / 100; END; 
IF ECBIO_CODE NE . THEN DO;ECBIO = ECBIO_CODE* AMOUNT / 100; END; 
IF TUWTR_CODE NE . THEN DO;TUWTR = TUWTR_CODE* AMOUNT / 100; END; 
IF ENTWTR_CODE NE . THEN DO;ENTWTR = ENTWTR_CODE* AMOUNT / 100; END; 
IF ETWTR_CODE NE . THEN DO;ETWTR = ETWTR_CODE* AMOUNT / 100; END; 
IF CAWTR_CODE NE . THEN DO;CAWTR = CAWTR_CODE* AMOUNT / 100; END; 
IF ENCWTR_CODE NE . THEN DO;ENCWTR = ENCWTR_CODE* AMOUNT / 100; END; 
IF ECWTR_CODE NE . THEN DO;ECWTR = ECWTR_CODE* AMOUNT / 100; END; 
IF TUCE_CODE NE . THEN DO;TUCE = TUCE_CODE* AMOUNT / 100; END; 
IF ENTCE_CODE NE . THEN DO;ENTCE = ENTCE_CODE* AMOUNT / 100; END; 
IF ETCE_CODE NE . THEN DO;ETCE = ETCE_CODE* AMOUNT / 100; END; 
IF CACE_CODE NE . THEN DO;CACE = CACE_CODE* AMOUNT / 100; END; 
IF ENCCE_CODE NE . THEN DO;ENCCE = ENCCE_CODE* AMOUNT / 100; END; 
IF ECCE_CODE NE . THEN DO;ECCE = ECCE_CODE* AMOUNT / 100; END; 

END;

/*Households no aplica*/
IF SECTOR = "HOUSEHOLDS" THEN DO;
	TUCCA = 'N/A' ;
	ENTCCA = 'N/A' ;
	ETCCA = 'N/A' ;
	CACCA = 'N/A' ;
	ENCCCA = 'N/A' ;
	ECCCA = 'N/A' ;
	TUCCM = 'N/A' ;
	ENTCCM = 'N/A' ;
	TRANT = 'N/A' ;
	ETCCM = 'N/A' ;
	CACCM = 'N/A' ;
	ENCCCM = 'N/A' ;
	TRANC = 'N/A' ;
	ECCCM = 'N/A' ;
	TUPPC = 'N/A' ;
	ETPPC = 'N/A' ;
	CAPPC = 'N/A' ;
	ECPPC = 'N/A' ;
	TUBIO = 'N/A' ;
	ETBIO = 'N/A' ;
	CABIO = 'N/A' ;
	ECBIO = 'N/A' ;
	TUWTR = 'N/A' ;
	ENTWTR = 'N/A' ;
	ETWTR = 'N/A' ;
	CAWTR = 'N/A' ;
	ENCWTR = 'N/A' ;
	ECWTR = 'N/A' ;
	TUCE = 'N/A' ;
	ENTCE = 'N/A' ;
	ETCE = 'N/A' ;
	CACE = 'N/A' ;
	ENCCE = 'N/A' ;
	ECCE = 'N/A' ;

END;
/*Real estate O Specific Purpose no aplica*/
IF MAIN_CATEGORY="REAL ESTATE" OR GS_PURPOSE = "Specific Purpose" THEN DO;
	TUCCA = 'N/A' ;
	ENTCCA = 'N/A' ;
	ETCCA = 'N/A' ;
	CACCA = 'N/A' ;
	ENCCCA = 'N/A' ;
	ECCCA = 'N/A' ;
	TUCCM = 'N/A' ;
	ENTCCM = 'N/A' ;
	TRANT = 'N/A' ;
	ETCCM = 'N/A' ;
	CACCM = 'N/A' ;
	ENCCCM = 'N/A' ;
	TRANC = 'N/A' ;
	ECCCM = 'N/A' ;
	TUPPC = 'N/A' ;
	ETPPC = 'N/A' ;
	CAPPC = 'N/A' ;
	ECPPC = 'N/A' ;
	TUBIO = 'N/A' ;
	ETBIO = 'N/A' ;
	CABIO = 'N/A' ;
	ECBIO = 'N/A' ;
	TUWTR = 'N/A' ;
	ENTWTR = 'N/A' ;
	ETWTR = 'N/A' ;
	CAWTR = 'N/A' ;
	ENCWTR = 'N/A' ;
	ECWTR = 'N/A' ;
	TUCE = 'N/A' ;
	ENTCE = 'N/A' ;
	ETCE = 'N/A' ;
	CACE = 'N/A' ;
	ENCCE = 'N/A' ;
	ECCE = 'N/A' ;
END;
	
IF SECTOR="GENERAL GOVERNMENTS" THEN DO;
TUCCA = 0 ;
ENTCCA = 0 ;
ETCCA = 0 ;
CACCA = 0 ;
ENCCCA = 0 ;
ECCCA = 0 ;
TUCCM = 0 ;
ENTCCM = 0 ;
TRANT = 0 ;
ETCCM = 0 ;
CACCM = 0 ;
ENCCCM = 0 ;
TRANC = 0 ;
ECCCM = 0 ;
TUPPC = 0 ;
ETPPC = 0 ;
CAPPC = 0 ;
ECPPC = 0 ;
TUBIO = 0 ;
ETBIO = 0 ;
CABIO = 0 ;
ECBIO = 0 ;
TUWTR = 0 ;
ENTWTR = 0 ;
ETWTR = 0 ;
CAWTR = 0 ;
ENCWTR = 0 ;
ECWTR = 0 ;
TUCE = 0 ;
ENTCE = 0 ;
ETCE = 0 ;
CACE = 0 ;
ENCCE = 0 ;
ECCE = 0 ;
END;

RUN;

**ORIGINATED DURING PERIOD*******************************************************************;
*PENDIENTE ENE25: CAMBIAR -5 POR -11 PARA TENER EN CUENTA EL AÑO 2024 COMPLETO***************;
*********************************************************************************************;
*********************************************************************************************;
*********************************************************************************************;
DATA S84_14;
SET S84_13;
FORMAT     ODP $3. ;
FORMAT     ODP_CODE $5. ;
/*PENDIENTE:cambiar en junio el -12 por el -6*, compara si la variable G4095_FECHAPER es mayor o igual a 12 meses antes del 31-dic. Si es así, asigna ORDP1/
/*si salta error, comillas en la letra b*/
IF G4095_FECHAPER >= INTNX("MONTH", &FECHA_LECTURA_DATOS., -5,"b") THEN DO 
     ODP_CODE = "ORDP1"; ODP = "YES";
END;
ELSE DO ODP_CODE = "ORDP2"; ODP = "No"; END;

RUN;
 
*********** CRUZO CON FICHERO PARA OBTENER LA NUEVA CODIFICACION DE LOS NACES********************;
PROC SQL;
CREATE TABLE CODIF_NACE AS
SELECT DISTINCT  A.*, B.NEW_NACE_ESG_CODE
FROM S84_14 A LEFT JOIN SAVE.NUEVA_CODIFICACION_NACE B
ON A.NACE_ESG_CODE_f = B.NACE_ESG_CODE_F;
RUN;


DATA CODIF_NACE_2 (drop = NACE_ESG_CODE_f rename = NEW_NACE_ESG_CODE = NACE_ESG_CODE_f);
SET CODIF_NACE;
RUN;

DATA INVEST_SECTOR;
SET CODIF_NACE_2;

IF SP_ELIG = "Climate Change Mitigation" AND SP_SUST = "N/A" THEN DO;SP_SUST='No'; SP_SUST_CODE='SSUS4';END;
IF PURPOSE_ESG_CODE="" THEN DO; PURPOSE_ESG_CODE="N/A";PURPOSE_ESG="N/A";END;

IF MAIN_CATEGORY="REAL ESTATE" AND ASSETS_ORIGIN NE "FORECLOSED/DATION IN PAYMENT" THEN DO; 
	ODP_CODE = "ORDP2"; ODP = "No"; GS_PURPOSE = "N/A"; GS_PURPOSE_CODE = "N/A";SP_ELIG ="N/A";SP_ELIG_CODE="N/A";SP_SUST="N/A";SP_SUST_CODE="N/A"; 
END;
RUN;

**ADJUSTMENT CODE*******************************************************************************;
DATA S84_15;
SET INVEST_SECTOR;
INFORMING_SOCIETY  = '00001';
ADJUSTMENT_CODE = "BI"||INFORMING_SOCIETY;

/*Solo se reporta NACEs para NFC*/
IF SECTOR NOT IN ('NON FINANCIAL CORPORATION') then do;
		NACEL1_CODE = "";
        NACE_ESG_CODE_f = "";
END;

RUN;

**ID_COMB***************************************************************************************;
DATA S84_16;
SET S84_15;
IF INVESTMENT_SECTOR_CODE Not in ("", "N/A") THEN ID_COMB00 = ";"||INVESTMENT_SECTOR_CODE;
ELSE ID_COMB00 ="";
IF ESG_SUBSECTOR_CODE NE "N/A" THEN ID_COMB0 = ";"||ESG_SUBSECTOR_CODE;
ELSE ID_COMB0 ="";
IF PURPOSE_ESG_CODE NE "N/A" THEN ID_COMB1 = ";"||PURPOSE_ESG_CODE;
ELSE ID_COMB1 ="";
IF NFRD_CODE NE "N/A" THEN ID_COMB2 = ";"||NFRD_CODE;
ELSE ID_COMB2 ="";
IF ODP_CODE NE "N/A" THEN ID_COMB3 = ";"||ODP_CODE;
ELSE ID_COMB3 ="";
IF GS_PURPOSE_CODE NE "N/A" THEN ID_COMB4 = ";"||GS_PURPOSE_CODE;
ELSE ID_COMB4 ="";
IF SP_LENDING_CODE NE "N/A" THEN ID_COMB5 = ";"||SP_LENDING_CODE;
ELSE ID_COMB5 ="";
IF SP_ELIG_CODE NE "N/A" THEN ID_COMB6 = ";"||SP_ELIG_CODE;
ELSE ID_COMB6 ="";
IF SP_SUST_CODE NE "N/A" THEN ID_COMB7 = ";"||SP_SUST_CODE;
ELSE ID_COMB7 ="";
RUN;


DATA save.SATELITE84_GRANULAR_OCT24;
SET S84_16;
ID_COMB = COMPRESS(COMB_ID)||COMPRESS(ID_COMB00)||COMPRESS(ID_COMB0)||COMPRESS(ID_COMB1)||COMPRESS(ID_COMB2)||COMPRESS(ID_COMB3)||COMPRESS(ID_COMB4)||COMPRESS(ID_COMB5)||COMPRESS(ID_COMB6)||COMPRESS(ID_COMB7);
RUN;

DATA AJUSTES_HERR;
SET save.SATELITE84_GRANULAR_OCT24;
/*Ajustes por errores en herramienta*/
IF ID_COMB = "HFS2;B01;MC02;ACPF6;SC02;COLL3;TYVA01;FVAD3;NFRD1;ORDP2;GSPUR2;SELI1;SSUS4" THEN DO;
	ID_COMB = "HFS2;B01;MC02;ACPF6;SC02;COLL4;TYVA01;FVAD3;NFRD1;ORDP2;GSPUR2;SELI1;SSUS4"; END;
IF ID_COMB = "HFS1;B01;MC1005;ORIG1;TYVA01;ORDP2;GSPUR2;SELI3" THEN DO;
	ID_COMB = "HFS1;B01;MC1005;ORIG1;TYVA01;ORDP2"; END;
IF ID_COMB = "HFS2;B01;MC1005;ORIG1;TYVA01;ORDP2;GSPUR2;SELI3" THEN DO;
	ID_COMB = "HHFS2;B01;MC1005;ORIG1;TYVA01;ORDP2"; END;
	IF ID_COMB = "HFS2;B01;MC1005;ORIG3;TYVA01;ORDP2;GSPUR2;SELI3" THEN DO;
	ID_COMB = "HFS2;B01;MC1005;ORIG3;TYVA01;ORDP2"; END;

IF ID_COMB = 'HFS2;B01;MC04;ACPF3;SC0302;COLL4;TYVA01;FVAD1;ESGS6;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF3;SC0302;COLL4;TYVA01;FVAD1;ESGS6;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC02;COLL4;TYVA01;FVAD3;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC02;COLL4;TYVA01;FVAD3;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC02;COLL4;TYVA01;FVAD3;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC02;COLL4;TYVA01;FVAD3;NFRD2;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD1;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD1;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD1;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD1;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL2;TYVA01;FVAD3;PESG4;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL2;TYVA01;FVAD3;PESG4;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL4;TYVA01;FVAD3;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL4;TYVA01;FVAD3;NFRD1;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL4;TYVA01;FVAD3;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL4;TYVA01;FVAD3;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF3;SC0302;COLL2;TYVA01;FVAD1;ESGS6;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF3;SC0302;COLL2;TYVA01;FVAD1;ESGS6;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD1;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL2;TYVA01;FVAD3;PESG4;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL2;TYVA01;FVAD3;PESG4;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD1;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD1;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD1;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD1;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF3;SC0302;COLL2;TYVA01;FVAD1;ESGS6;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF3;SC0302;COLL2;TYVA01;FVAD1;ESGS6;NFRD2;ORDP1;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL4;TYVA01;FVAD3;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL4;TYVA01;FVAD3;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC02;COLL4;TYVA01;FVAD3;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC02;COLL4;TYVA01;FVAD3;NFRD2;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF3;SC0302;COLL4;TYVA01;FVAD1;ESGS6;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF3;SC0302;COLL4;TYVA01;FVAD1;ESGS6;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL4;TYVA01;FVAD3;ESGS6;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL2;TYVA01;FVAD3;ESGS6;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC02;COLL4;TYVA01;FVAD3;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC02;COLL4;TYVA01;FVAD3;NFRD2;ORDP1;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0302;COLL2;TYVA01;FVAD3;ESGS3;NFRD2;ORDP2;GSPUR2;SELI1;SSUS4';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL4;TYVA01;FVAD3;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF6;SC0303;COLL4;TYVA01;FVAD3;NFRD1;ORDP2;GSPUR1';END;
IF ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB = 'HFS2;B01;MC04;ACPF5;SC0302;COLL4;TYVA01;FVAD3;ESGS3;NFRD1;ORDP2;GSPUR1';END;
/*Combinacion no permitida por la herramienta*/

IF ID_COMB = 'HFS2;B01;MC02;ACPF1;SC02;TYVA01;NFRD2;ORDP1;GSPUR1' THEN DO; ID_COMB='HFS2;B01;MC02;ACPF1;SC02;TYVA01;NFRD2;ORDP1';END;
IF ID_COMB = 'HFS2;B01;MC02;ACPF1;SC02;TYVA01;NFRD2;ORDP2;GSPUR1' THEN DO; ID_COMB='HFS2;B01;MC02;ACPF1;SC02;TYVA01;NFRD2;ORDP2';END;
IF ID_COMB = 'HFS2;B01;MC02;ACPF1;SC02;TYVA01;NFRD1;ORDP1;GSPUR1' THEN DO; ID_COMB='HFS2;B01;MC02;ACPF1;SC02;TYVA01;NFRD1;ORDP1';END;
IF ID_COMB = 'HFS2;B01;MC02;ACPF1;SC02;TYVA01;NFRD1;ORDP2;GSPUR1' THEN DO; ID_COMB='HFS2;B01;MC02;ACPF1;SC02;TYVA01;NFRD1;ORDP2';END;

/*IF ID_COMB= 'HFS2;B01;MC02;ACPF1;SC01;ORDP1' THEN DELETE;*/
/*IF ID_COMB= 'HFS2;B01;MC02;ACPF1;SC01;ORDP2' THEN DELETE;*/

RUN;

**AGRUPACIONES***********************************************************************************;
PROC SQL;
CREATE TABLE SATELITE84 AS
SELECT DISTINCT INFORMING_SOCIETY AS INFORMING_SOC,
COUNTERPARTY_ENTITY AS COUNTERPARTY_SOC, 
ADJUSTMENT_CODE,
CLASSIFIED_AS_HELD_FOR_SALE,
BASE, 
MAIN_CATEGORY,
ACCOUNTING_PORTFOLIO, 
SECTOR,
ASSETS_ORIGIN,
COLLATERAL,
type_of_value,
FAIR_VALUE_DETAIL,
INVESTMENT_SECTOR_CODE,
ESG_SUBSECTOR_CODE,
PURPOSE_ESG_CODE,
NFRD_CODE,
ODP_CODE,
GS_PURPOSE_CODE,
SP_LENDING_CODE,
SP_ELIG_CODE,
SP_SUST_CODE,
EU_CODE,
NACEL1_CODE AS CNAEL,
NACE_ESG_CODE_f AS NACE,
ID_COMB as COMB_CODE,
SUM(AMOUNT) AS AMOUNT, 
SUM(TUCCM) AS TUCCM,
SUM(ETCCM) AS ETCCM,
SUM(TRANT) AS TRANT,
SUM(ENTCCM) AS ENTCCM,
SUM(TUCCA) AS TUCCA,
SUM(ETCCA) AS ETCCA,
SUM(ENTCCA) AS ENTCCA,
SUM(TUWTR) AS TUWTR,
SUM(ETWTR) AS ETWTR,
SUM(ENTWTR) AS ENTWTR,
SUM(TUCE) AS TUCE,
SUM(ETCE) AS ETCE,
SUM(ENTCE) AS ENTCE,
SUM(TUPPC) AS TUPPC,
SUM(ETPPC) AS ETPPC,
SUM(TUBIO) AS TUBIO,
SUM(ETBIO) AS ETBIO,
SUM(CACCM) AS CACCM,
SUM(ECCCM) AS ECCCM,
SUM(TRANC) AS TRANC,
SUM(ENCCCM) AS ENCCCM,
SUM(CACCA) AS CACCA,
SUM(ECCCA) AS ECCCA,
SUM(ENCCCA) AS ENCCCA,
SUM(CAWTR) AS CAWTR,
SUM(ECWTR) AS ECWTR,
SUM(ENCWTR) AS ENCWTR,
SUM(CACE) AS CACE,
SUM(ECCE) AS ECCE,
SUM(ENCCE) AS ENCCE,
SUM(CAPPC) AS CAPPC,
SUM(ECPPC) AS ECPPC,
SUM(CABIO) AS CABIO,
SUM(ECBIO) AS ECBIO
FROM AJUSTES_HERR
GROUP BY INFORMING_SOCIETY, 
           COUNTERPARTY_ENTITY, 
           ADJUSTMENT_CODE ,
           CLASSIFIED_AS_HELD_FOR_SALE,
			BASE, 
			MAIN_CATEGORY,
			ACCOUNTING_PORTFOLIO, 
			SECTOR,
			ASSETS_ORIGIN,
			COLLATERAL,
			type_of_value,
			FAIR_VALUE_DETAIL,
			INVESTMENT_SECTOR_CODE,
			ESG_SUBSECTOR_CODE,
			PURPOSE_ESG_CODE,
			NFRD_CODE,
			ODP_CODE,
			GS_PURPOSE_CODE,
			SP_LENDING_CODE,
			SP_ELIG_CODE,
			SP_SUST_CODE,
			ID_COMB,
			EU_CODE,
			NACEL1_CODE,
			NACE_ESG_CODE_f;
QUIT;

DATA SAVE.SATELITE84_PREAJUSTES_OCT24;
SET SATELITE84;
FORMAT TUCCM ETCCM TRANT ENTCCM TUCCA ETCCA ENTCCA TUWTR ETWTR ENTWTR TUCE ETCE ENTCE TUPPC ETPPC TUBIO ETBIO CACCM ECCCM TRANC ENCCCM CACCA ECCCA ENCCCA CAWTR ECWTR ENCWTR CACE ECCE ENCCE CAPPC ECPPC CABIO ECBIO 30.2;
RUN;






%LET _CLIENTTASKLABEL=;
%LET _CLIENTPROCESSFLOWNAME=;
%LET _CLIENTPROJECTPATH=;
%LET _CLIENTPROJECTPATHHOST=;
%LET _CLIENTPROJECTNAME=;
%LET _SASPROGRAMFILE=;
%LET _SASPROGRAMFILEHOST=;

;*';*";*/;quit;run;
ODS _ALL_ CLOSE;
